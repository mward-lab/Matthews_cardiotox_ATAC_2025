---
title: "TEs and my data"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

```{css, echo=FALSE}
pre {
  max-height: 400px;
  overflow-y: auto;
}

pre[class] {
  max-height: 200px;
}
```

```{r package loading, message=FALSE, warning=FALSE}
library(tidyverse)
library(kableExtra)
library(broom)
library(RColorBrewer)
library(ChIPseeker)
library("TxDb.Hsapiens.UCSC.hg38.knownGene")
library("org.Hs.eg.db")
library(rtracklayer)
library(edgeR)
library(ggfortify)
library(limma)
library(readr)
library(BiocGenerics)
library(gridExtra)
library(VennDiagram)
library(scales)
library(BiocParallel)
library(ggpubr)
library(devtools)
library(biomaRt)
library(eulerr)
library(smplot2)
library(genomation)
library(ggsignif)
library(plyranges)
library(ggrepel)
library(readr)
```
##### loading data

This is where I pull in the repeatmasker file taken from UCSC genomebrowser, the peaks assigned with the closest expressed genes as 'neargenes' by TSS,  the same peaks list, only condensing to unique peaks (some are assigned to two neargene), I call the collapsed_peaks and the peaks assigned to each MRC (EAR, etc...).  
With the TSS data and the collapsed data, I make granges files.  I also separate out the LINEs, SINEs, LTRs, DNAs, and Retroposons from the repeatmasker to make granges from those sets.  
```{r first data sets}
repeatmasker <- read.delim("data/other_papers/repeatmasker.tsv")

TSS_NG_data <- read_delim("data/n45_bedfiles/TSS_NG_data.tsv", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE)
Collapsed_peaks <- read_delim("data/n45_bedfiles/TSS_NG_data_collapsed_peaks.tsv",
                              delim = "\t", 
                              escape_double = FALSE, 
                              trim_ws = TRUE)
TSS_data_gr <- TSS_NG_data %>% 
  dplyr::filter(seqnames != "chrX") %>% 
  dplyr::filter(seqnames != "chrY") %>%
  GRanges()

Col_TSS_data_gr <- Collapsed_peaks %>% 
  dplyr::filter(seqnames != "chrX") %>% 
  dplyr::filter(seqnames != "chrY") %>%
  GRanges()

reClass_list <- repeatmasker %>% 
  distinct(repClass)

Line_repeats <- repeatmasker %>% 
  dplyr::filter(repClass == "LINE") %>% 
 makeGRangesFromDataFrame(., keep.extra.columns = TRUE, seqnames.field = "genoName", start.field = "genoStart", end.field = "genoEnd",starts.in.df.are.0based=TRUE)

Sine_repeats <- repeatmasker %>% 
  dplyr::filter(repClass == "SINE") %>% 
 makeGRangesFromDataFrame(., keep.extra.columns = TRUE, seqnames.field = "genoName", start.field = "genoStart", end.field = "genoEnd",starts.in.df.are.0based=TRUE)

LTR_repeats <- repeatmasker %>% 
  dplyr::filter(repClass == "LTR") %>% 
 makeGRangesFromDataFrame(., keep.extra.columns = TRUE, seqnames.field = "genoName", start.field = "genoStart", end.field = "genoEnd",starts.in.df.are.0based=TRUE)

DNA_repeats <- repeatmasker %>% 
  dplyr::filter(repClass == "DNA") %>% 
 makeGRangesFromDataFrame(., keep.extra.columns = TRUE, seqnames.field = "genoName", start.field = "genoStart", end.field = "genoEnd",starts.in.df.are.0based=TRUE)

retroposon_repeats <- repeatmasker %>% 
  dplyr::filter(repClass == "Retroposon") %>% 
 makeGRangesFromDataFrame(., keep.extra.columns = TRUE, seqnames.field = "genoName", start.field = "genoStart", end.field = "genoEnd",starts.in.df.are.0based=TRUE)


all_TEs_gr <- repeatmasker %>% 
 makeGRangesFromDataFrame(., keep.extra.columns = TRUE, seqnames.field = "genoName", start.field = "genoStart", end.field = "genoEnd",starts.in.df.are.0based=TRUE)


peakAnnoList_n45_motif <- readRDS("data/peakAnnoList_n45_motif.RDS")

EAR_df <- as.data.frame(peakAnnoList_n45_motif$EAR_n45_gr)
# EAR_df_gr <-  as.GRanges(peakAnnoList_n45_motif$EAR_n45_gr)

ESR_df <- as.data.frame(peakAnnoList_n45_motif$ESR_n45_gr)
# ESR_df_gr <- as.GRanges(peakAnnoList_n45_motif$ESR_n45_gr)

LR_df <- as.data.frame(peakAnnoList_n45_motif$LR_n45_gr)
# LR_df_gr <-  as.GRanges(peakAnnoList_n45_motif$LR_n45_gr)

NR_df <- as.data.frame(peakAnnoList_n45_motif$NR_n45_gr)
# NR_df_gr <-  as.GRanges(peakAnnoList_n45_motif$NR_n45_gr)


```

##  TE distrubution:

The code below uses the TE data sets to create dataframes that contain all peaks that overlap a TE. Additionally, I wanted to know size distribution of the overlaps(width) between TEs and my peaks, the size of the TEs and their size distribution, and the size distribution of my peaks.  This was to determine a cutoff across TEs to minimize size bais. My first attempt was a threshold of >50% of TE needed to be covered by a peak to infer the peak contained the TE. In the plots, the median of each density distribution is shown by the dotted line.

```{r  data about TEs}
# length(retroposon_repeats)
# ##5974
# length(Sine_repeats)
# ##1910631
# length(Line_repeats)
# ## 1614481
# length(LTR_repeats)
# ## 770551
# length(DNA_repeats)
# ## 512404
# length(intersect_ranges(TSS_data_gr,retroposon_repeats))

# 
# length(intersect_ranges(TSS_data_gr,Line_repeats))
# length(intersect_ranges(TSS_data_gr,Sine_repeats))
# 
# length(intersect_ranges(TSS_data_gr,LTR_repeats))
# length(intersect_ranges(TSS_data_gr,DNA_repeats))
# length(intersect_ranges(TSS_data_gr,all_TEs_gr))


Col_TSS_data_gr %>% 
  as.data.frame %>% 
   ggplot(., aes(x=width))+
    geom_density(color="darkblue",fill="lightblue",aes(alpha = 0.5))+
  geom_vline(data=Col_TSS_data_gr$width., aes(xintercept = median(width)), linetype = 2)+
  theme_classic()+
  ggtitle("Distribution of peak length across all peaks",subtitle = " limited x axis")+
  coord_cartesian(xlim= c(0,2500))



all_TEs_gr %>% 
  as.data.frame() %>% 
  mutate(repClass=factor(repClass)) %>% 
  dplyr::filter(repClass=="LINE") %>% 
  ggplot(., aes(x=width))+
    geom_density(aes(fill=repClass, alpha = 0.5))+
  geom_vline(aes(xintercept = median(width)), linetype = 2)+
  theme_classic()+
  ggtitle("Distribution of widths of all LINEs across human genome",subtitle = " limited x axis")+
  coord_cartesian(xlim= c(0,2500))

all_TEs_gr %>% 
  as.data.frame() %>% 
  mutate(repClass=factor(repClass)) %>% 
  dplyr::filter(repClass=="SINE") %>% 
  ggplot(., aes(x=width))+
    geom_density(aes(fill=repClass, alpha = 0.5))+
   geom_vline(aes(xintercept = median(width)), linetype = 2)+
  theme_classic()+
  ggtitle("Distribution of widths of all SINEs across human genome")

all_TEs_gr %>% 
  as.data.frame() %>% 
  mutate(repClass=factor(repClass)) %>% 
  dplyr::filter(repClass=="LTR") %>% 
  ggplot(., aes(x=width))+
    geom_density(aes(fill=repClass, alpha = 0.5))+
   geom_vline(aes(xintercept = median(width)), linetype = 2)+
  theme_classic()+
  ggtitle("Distribution of widths of all LTRs across human genome",subtitle = " limited x axis")+
  coord_cartesian(xlim= c(0,2500))

all_TEs_gr %>% 
  as.data.frame() %>% 
  mutate(repClass=factor(repClass)) %>% 
  dplyr::filter(repClass=="DNA") %>% 
  ggplot(., aes(x=width))+
    geom_density(aes(fill=repClass, alpha = 0.5))+
   geom_vline(aes(xintercept = median(width)), linetype = 2)+
  theme_classic()+
  ggtitle("Distribution of widths of all DNA-TEs across human genome",subtitle = " limited x axis")+
  coord_cartesian(xlim= c(0,2500))

all_TEs_gr %>% 
  as.data.frame() %>% 
  mutate(repClass=factor(repClass)) %>% 
  dplyr::filter(repClass=="Retroposon") %>% 
  ggplot(., aes(x=width))+
    geom_density(aes(alpha = 0.5))+
   geom_vline(aes(xintercept = median(width)), linetype = 2)+
  theme_classic()+
  ggtitle("Distribution of widths of all Retroposons across human genome",subtitle = " limited x axis")+
   coord_cartesian(xlim= c(0,2500))

all_TEs_gr %>% 
  as.data.frame() %>% 
  dplyr::select(repClass, width) %>% 
  # dplyr::filter(repClass=="LTR") %>%
  group_by(repClass) %>% 
  summarise(med.width=median(width),mean.width=mean(width))

fullDF_overlap <- join_overlap_intersect(TSS_data_gr,all_TEs_gr)
fullDF_overlap %>% 
  as.data.frame() %>% 
  group_by(repClass) %>%  
  tally %>% 
  kable(., caption="Count of peaks by TE class; overlap 1 bp or greater") %>% 
  kable_paper("striped", full_width = TRUE) %>%
  kable_styling(full_width = FALSE, font_size = 14)

subsetByOverlaps(TSS_data_gr,all_TEs_gr) %>% as.data.frame %>% 
   ggplot(., aes(x=width))+
    geom_density(color="darkblue",fill="lightblue",aes(alpha = 0.5))+
   geom_vline(aes(xintercept = median(width)), linetype = 2)+
  theme_classic()+
  ggtitle("Distribution of overlaps between all TEs and all my peaks",subtitle = " limited x axis")+
  coord_cartesian(xlim= c(0,2500))

### This is how I subset only those peaks who cover >50% of TEs
hits <- findOverlaps(TSS_data_gr,all_TEs_gr)
overlaps <- pintersect(TSS_data_gr[queryHits(hits)], all_TEs_gr[subjectHits(hits)])
percentOverlap <- width(overlaps) / width(all_TEs_gr[subjectHits(hits)])
hits <- hits[percentOverlap > 0.5]

testingol <- TSS_data_gr[queryHits(hits)]
testingol %>% as.data.frame() %>% 
  left_join(., (fullDF_overlap %>% as.data.frame(.)), by =c("seqnames"="seqnames","start"="start","end"="end","peakid"="peakid", "NG_start"="NG_start", "end_position"="end_position", "entrezgene_id"="entrezgene_id", "ensembl_gene_id"="ensembl_gene_id","dist_to_NG"="dist_to_NG", "width"="width", "strand"="strand", "hgnc_symbol" = "hgnc_symbol")) %>% 
  group_by(repClass) %>% 
  tally %>% 
  kable(., caption="Count of peaks by TE class; overlap> 50%") %>% 
  kable_paper("striped", full_width = TRUE) %>%
  kable_styling(full_width = FALSE, font_size = 14)
```
  The first dataframe to subset peaks that overlap >50% of a TE, was using the full neargene dataframe, where a peak is listed more than once because it was assigned more than one neargene ( one-to-many relationships).   I changed the code to use the 'collapsed' data frame.  This means the data frame was simplified to only include peaks one time, but those peaks that were assigned to more than one neargene had the assigned neargenes condensed and separated by a comma into the same column to create a one-to-one relationship dataframe.  (yes, wordy I know)
```{r run again}
######################################################
all_TEs_gr$TE_width <- width(all_TEs_gr)
Col_TSS_data_gr$peak_width <- width(Col_TSS_data_gr)
Col_fullDF_overlap <- join_overlap_intersect(Col_TSS_data_gr,all_TEs_gr)
Col_fullDF_overlap %>% 
  as.data.frame() %>% 
  group_by(repClass) %>%  
  tally %>% 
  kable(., caption="Count of peaks by TE class; overlap at least 1 bp; using one:one df ") %>% 
  kable_paper("striped", full_width = TRUE) %>%
  kable_styling(full_width = FALSE, font_size = 14)

Col_fullDF_overlap %>% 
   as.data.frame %>% 
  mutate(per_ol= width/TE_width) %>% 
  dplyr::filter(per_ol>0.5) %>% 
  group_by(repClass) %>% 
  tally() %>% 
  kable(., caption="Count of peaks by TE class; overlap of >50% of TE; newway ") %>% 
  kable_paper("striped", full_width = TRUE) %>%
  kable_styling(full_width = FALSE, font_size = 14)
 


hits_col <- findOverlaps(Col_TSS_data_gr,all_TEs_gr)

overlaps_col <- pintersect(Col_TSS_data_gr[queryHits(hits_col)], all_TEs_gr[subjectHits(hits_col)])
percentOverlap_col <- width(overlaps_col) / width(all_TEs_gr[subjectHits(hits_col)])
hits_col2 <- hits_col[percentOverlap_col > 0.5]

testingol_col2 <- Col_TSS_data_gr[queryHits(hits_col2)] 
just_TEdata <- all_TEs_gr[subjectHits(hits_col2)]

# testingol_col2 %>% as.data.frame() %>% 
#   left_join(., (Col_fullDF_overlap %>% as.data.frame(.)), by =c("seqnames"="seqnames","start"="start","end"="end","peakid"="peakid", "NCBI_gene"="NCBI_gene", "ensembl_ID"="ensembl_ID","dist_to_NG"="dist_to_NG", "width"="width", "strand"="strand", "SYMBOL" = "SYMBOL")) %>% 
#   distinct(.,.keep_all = TRUE) %>% 
#   group_by(repClass) %>% 
#   tally %>% 
#   kable(., caption="Count of peaks by TE class; overlap> 50%; using one:one df") %>% 
#   kable_paper("striped", full_width = TRUE) %>%
#   kable_styling(full_width = FALSE, font_size = 14)
#   
just_TEdata %>% 
  as.data.frame %>% 
  distinct(., .keep_all = TRUE) %>% 
  group_by(repClass) %>% 
  tally %>% 
  kable(., caption="Count of peaks by TE class Just TE list; overlap> 50%; using one:one df") %>% 
  kable_paper("striped", full_width = TRUE) %>%
  kable_styling(full_width = FALSE, font_size = 14)
  


testingol_col2 %>% 
  as.data.frame() %>% 
  group_by(peakid) %>% 
  tally %>% 
  summary()
Unique_peak_overlap <- Col_fullDF_overlap %>% 
  as.data.frame() %>% 
  distinct(peakid)

peak_overlap_50unique <- testingol_col2 %>% 
  as.data.frame() %>% 
  distinct(peakid)


```
Note that the counts of peaks total to more than the total number of peaks that overlap a TE because many peaks overlap multiple elements (generally the very small ones)

A summary of numbers of peaks is below:
* Total number of peaks = `r length(Collapsed_peaks$peakid)`
* Total number of peaks overlapping at least 1 TE = `r length(Unique_peak_overlap$peakid)`
* Total number of peaks overlapping by >50% TE length = `r length(peak_overlap_50unique$peakid)`

Because I subset the data in a weird way,  I noticed a sub-setting error when tallying up the TEs by Class.  I was using the query hits and later joining the Peaks back to a dataframe, forgetting there were peaks that hit more than one dataframe.  The 2nd data frame above was the "new" way of sub-setting (keeping all metadata organized vs the sub-setting code I found on the internet).  Just to verify the numbers were the same, I ran the data using the old method and compared the numbers.  They are identical (3rd dataframe above) to each other.  Success!

```{r another set of plots}
scale_fill_repeat <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7",
                             "#FFFFB3",
                             "#BEBADA" ,
                             "#FB8072",
                             "#80B1D3",
                             "#FDB462",
                             "#B3DE69",
                             "#FCCDE5",
                             "#D9D9D9",
                             "#BC80BD",
                             "#CCEBC5",
                             "pink4",
                             "cornflowerblue",
                             "chocolate",
                             "brown",
                             "green",
                             "yellow4",
                             "purple",
                             "darkorchid4",
                             "coral4",
                             "darkolivegreen4",
                             "darkorange"), unique(repeatmasker$repClass)), 
      ...
    )
}
Col_fullDF_overlap %>%  
  as.data.frame %>% 
  ggplot(., aes(x=width, fill=repClass))+
    geom_density(color="darkblue",aes(alpha = 0.5))+
  theme_classic()+
  ggtitle("density of width of all overlapping peaks in my data",subtitle = " limited x axis")+
  coord_cartesian(xlim= c(0,750))+
  scale_fill_repeat()
  
Col_fullDF_overlap %>%  
  as.data.frame %>% 
  dplyr::filter(repClass=="LINE"|repClass=="SINE"|repClass =="LTR"|repClass=="DNA"|repClass =="Retroposon") %>% 
  ggplot(., aes(x=width, fill=repClass))+
    geom_density(color="darkblue",aes(alpha = 0.5))+
  theme_classic()+
  ggtitle("density of width of all peak-TE overlaps",subtitle = " limited x axis")+
  coord_cartesian(xlim= c(0,1550))+
  scale_fill_repeat()


Peak_TE_overlapbreakdown <- Col_TSS_data_gr %>% as.data.frame %>% 
  dplyr::select(peakid) %>% 
  left_join(.,(Col_fullDF_overlap %>% as.data.frame)) %>% 
   mutate(TEstatus=if_else(is.na(repClass),"not_TE_peak","TE_peak")) %>% 
   mutate(mrc=if_else(peakid %in% EAR_df$id, "EAR",
                     if_else(peakid %in% ESR_df$id,"ESR",
                             if_else(peakid %in% LR_df$id,"LR",
                                     if_else(peakid %in% NR_df$id,"NR","not_mrc")))))
  
 
```

The data above shows the unique peak count of TE overlaps, followed by the table that includes only those TEs that overlap a peak by more than 50%.  The third summary shows how many peaks overlap more than one TE.  Most peaks only overlap 1  TE, but several peaks overlap 2 or more TEs.  


This next data is a breakdown of the number of TEs by response group.

```{r TE in all peaks}

# testingol_col2$width_ol=width(testingol_col2)

TE_mrc_status_list <- testingol_col2 %>% as.data.frame() %>% 
  left_join(., (Col_fullDF_overlap %>% as.data.frame(.)), by =c("seqnames"="seqnames","start"="start","end"="end","peakid"="peakid", "NCBI_gene"="NCBI_gene", "ensembl_ID"="ensembl_ID","dist_to_NG"="dist_to_NG",  "strand"="strand", "SYMBOL" = "SYMBOL")) #%>% 
    dplyr::select(peakid,repName,repClass,repFamily,width) %>% 
  mutate(TEstatus=if_else(is.na(repClass),"not_TE_peak","TE_peak"))#%>% 
   mutate(mrc=if_else(peakid %in% EAR_df$id, "EAR",
                     if_else(peakid %in% ESR_df$id,"ESR",
                             if_else(peakid %in% LR_df$id,"LR",
                                     if_else(peakid %in% NR_df$id,"NR","not_mrc")))))


scale_fill_TE <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7", "#FFFFB3", "#BEBADA" ,"#FB8072", "#80B1D3", "#FDB462", "#B3DE69", "#FCCDE5", "#D9D9D9","#BC80BD", "#CCEBC5"), unique(TE_mrc_status_list$repClass)), 
        ...
    )
}

# saveRDS(TE_mrc_status_list,"data/TE_info/TE_mrc_status_list.RDS")
TE_ALL_count <- Peak_TE_overlapbreakdown %>% 
  dplyr::filter(TEstatus =="TE_peak") %>% 
  dplyr::filter(mrc!="not_mrc") %>% 
  distinct(peakid) %>% 
    count
TE_mrc_status_list %>% 
   mutate(repClass=factor(repClass)) %>% 
  group_by(repClass) %>% 
  dplyr::filter(TEstatus =="TE_peak") %>% 
   count(repClass) %>% 
   arrange(desc(n)) %>% 
  mutate(repClass = fct_rev(fct_inorder(repClass))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repClass)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = repClass),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("TE breakdown of all peaks",subtitle = paste(TE_ALL_count$n))+
  scale_fill_TE()


TE_mrc_status_list %>% 
  dplyr::filter(TEstatus=="TE_peak") %>% 
  mutate(repClass=factor(repClass)) %>% 
  ggplot(., aes(x=width))+
    geom_density(aes(fill=repClass, alpha = 0.5))+
  scale_fill_TE()+
  theme_classic()+
  ggtitle("Density of width of all TEs where a peak covers >50%")


Peak_TE_overlapbreakdown%>% 
  dplyr::filter(TEstatus=="TE_peak") %>% 
  mutate(repClass=factor(repClass)) %>% 
  ggplot(., aes(x=width))+
    geom_density(aes(fill=repClass, alpha = 0.5))+
  scale_fill_TE()+
  theme_classic()+
   # coord_cartesian(xlim= c(0,500))+
  ggtitle("Distribution of all overlaps between TEs and my peaks")+
  scale_fill_repeat()
  

```
### TE by response cluster

```{r EAR}
TE_EAR_count <- TE_mrc_status_list %>% 
  dplyr::filter(TEstatus =="TE_peak"&mrc=="EAR") %>% 
  count
# TE_EAR_LTR <- TE_mrc_status_list %>% 
#   dplyr::filter(TEstatus =="TE_peak"&mrc=="EAR"& rep) %>% 
#   count

TE_mrc_status_list %>% 
   mutate(repClass=factor(repClass)) %>% 
  group_by(repClass) %>% 
  dplyr::filter(TEstatus =="TE_peak"&mrc=="EAR") %>% 
   count(repClass) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repClass = fct_rev(fct_inorder(repClass))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repClass)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("EAR-TE peak breakdown",subtitle = paste(TE_EAR_count$n))+
  scale_fill_TE()

LTR_family <- TE_mrc_status_list %>% 
  dplyr::filter(repClass == "LTR") %>% 
   mutate(repFamily=factor(repFamily)) %>% 
    distinct(repFamily) 

scale_fill_LTR_family <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7", "#FFFFB3", "#BEBADA" ,"#FB8072", "#80B1D3", "#FDB462", "#B3DE69", "#FCCDE5"), unique(LTR_family$repFamily)), 
        ...
    )
}

LTR_df <- LTR_repeats %>% 
  as.data.frame() %>% 
  mutate(repFamily=factor(repFamily))

scale_fill_LTRs <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7",
                             "#FFFFB3",
                             "#BEBADA" ,
                             "#FB8072",
                             "#80B1D3",
                             "#FDB462",
                             "#B3DE69",
                             "#FCCDE5",
                             "#D9D9D9",
                             "#BC80BD",
                             "#CCEBC5",
                             "pink4",
                             "cornflowerblue",
                             "chocolate",
                             "brown",
                             "green",
                             "yellow4",
                             "purple",
                             "darkorchid4",
                             "coral4",
                             "darkolivegreen4",
                             "darkorange"), unique(LTR_df$repFamily)), 
      ...
    )
}


DNA_family <- TE_mrc_status_list %>% 
  dplyr::filter(repClass == "DNA") %>% 
   mutate(repFamily=factor(repFamily)) %>% 
    distinct(repFamily) 

scale_fill_DNA_family <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7", "#FFFFB3", "#BEBADA" ,"#FB8072", "#80B1D3", "#FDB462", "#B3DE69", "#FCCDE5", "purple4"), unique(DNA_family$repFamily)), 
        ...
    )
}

LTR_EAR_count <- TE_mrc_status_list %>% 
   dplyr::filter(repClass == "LTR"& mrc=="EAR") %>% 
  count

TE_mrc_status_list %>% 
  dplyr::filter(repClass == "LTR"& mrc=="EAR") %>% 
   mutate(repFamily=factor(repFamily)) %>% 
     group_by(repFamily) %>% 
  count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("EAR-LTR peak breakdown",subtitle = paste(LTR_EAR_count$n))+
  scale_fill_LTR_family()



```


```{r ESR-te}
TE_ESR_count <- TE_mrc_status_list %>% 
  dplyr::filter(TEstatus =="TE_peak"&mrc=="ESR") %>% 
  count

TE_mrc_status_list %>% 
   mutate(repClass=factor(repClass)) %>% 
  group_by(repClass) %>% 
  dplyr::filter(TEstatus =="TE_peak"&mrc=="ESR") %>% 
   count(repClass) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repClass = fct_rev(fct_inorder(repClass))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repClass)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("ESR-TE peak breakdown", subtitle = paste(TE_ESR_count$n))+
   scale_fill_TE()

LTR_ESR_count <- TE_mrc_status_list %>% 
   dplyr::filter(repClass == "LTR"& mrc=="ESR") %>% 
  count
TE_mrc_status_list %>% 
 dplyr::filter(repClass == "LTR"& mrc=="ESR") %>% 
   mutate(repFamily=factor(repFamily)) %>% 
     group_by(repFamily) %>% 
  count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("ESR-LTR peak breakdown",subtitle = paste(LTR_ESR_count$n))+
  scale_fill_LTR_family()



```


```{r LRTE}
TE_LR_count <- TE_mrc_status_list %>% 
  dplyr::filter(TEstatus =="TE_peak"&mrc=="LR") %>% 
  count
TE_mrc_status_list %>% 
   mutate(repClass=factor(repClass)) %>% 
  group_by(repClass) %>% 
  dplyr::filter(TEstatus =="TE_peak"&mrc=="LR") %>% 
   count(repClass) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repClass = fct_rev(fct_inorder(repClass))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repClass)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("LR-TE peak breakdown",subtitle=paste(TE_LR_count$n))+
   scale_fill_TE()

LTR_LR_count <- TE_mrc_status_list %>% 
   dplyr::filter(repClass == "LTR"& mrc=="LR") %>% 
  count
TE_mrc_status_list %>% 
 dplyr::filter(repClass == "LTR"& mrc=="LR") %>% 
   mutate(repFamily=factor(repFamily)) %>% 
     group_by(repFamily) %>% 
  count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("LR-LTR peak breakdown",subtitle = paste(LTR_LR_count$n))+
  scale_fill_LTR_family()


```


```{r NR-te}
TE_NR_count <- TE_mrc_status_list %>% 
  #  mutate(repClass=factor(repClass)) %>% 
  # group_by(repClass) %>% 
  dplyr::filter(TEstatus =="TE_peak"&mrc=="NR") %>% 
  count
TE_mrc_status_list %>% 
   mutate(repClass=factor(repClass)) %>% 
  group_by(repClass) %>% 
  dplyr::filter(TEstatus =="TE_peak"&mrc=="NR") %>% 
   count(repClass) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repClass = fct_rev(fct_inorder(repClass))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repClass)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("NR-TE peak breakdown", subtitle=paste(TE_NR_count$n))+
   scale_fill_TE()


LTR_NR_count <- TE_mrc_status_list %>% 
   dplyr::filter(repClass == "LTR"& mrc=="NR") %>% 
  count
TE_mrc_status_list %>% 
 dplyr::filter(repClass == "LTR"& mrc=="NR") %>% 
   mutate(repFamily=factor(repFamily)) %>% 
     group_by(repFamily) %>% 
  count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("NR-LTR peak breakdown",subtitle = paste(LTR_NR_count$n))+
  scale_fill_LTR_family()

TE_LTR_count <- TE_mrc_status_list %>% 
  dplyr::filter(TEstatus =="TE_peak"&repClass=="LTR") %>% 
  count

# TE_mrc_status_list %>% 
#   dplyr::filter(repClass == "LTR") %>% 
#    mutate(repFamily=factor(repFamily)) %>% 
#      group_by(repFamily) %>% 
#   count(repFamily) %>% 
#    mutate(perc= n/sum(n)) %>% 
#    arrange(desc(n)) %>% 
#   mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
#   mutate(text_y = cumsum(n) - n/2) %>% 
#   ggplot(., aes(x = "", y = n, fill = repFamily)) +
#   geom_col(color = "black") +
#   coord_polar(theta = "y", start = 0)+
#    # geom_label(aes(label = repClass),
#    #          position = position_stack(vjust = .8)) +
#   # geom_label(aes(label=repClass, y=text_y))
#    geom_label_repel(aes(label = n),
#                      position = position_stack(vjust = .3),
#                      show.legend = FALSE,max.overlaps = 50) +
#   theme_void()+
#   ggtitle("LTR breakdown of peaks",subtitle=paste(TE_LTR_count$n))+
#   scale_fill_LTRs()
```


### Human genome TE breakdown
```{r repeatmasker genome breakdown}
scale_fill_repeat <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7",
                             "#FFFFB3",
                             "#BEBADA" ,
                             "#FB8072",
                             "#80B1D3",
                             "#FDB462",
                             "#B3DE69",
                             "#FCCDE5",
                             "#D9D9D9",
                             "#BC80BD",
                             "#CCEBC5",
                             "pink4",
                             "cornflowerblue",
                             "chocolate",
                             "brown",
                             "green",
                             "yellow4",
                             "purple",
                             "darkorchid4",
                             "coral4",
                             "darkolivegreen4",
                             "darkorange"), unique(repeatmasker$repClass)), 
      ...
    )
}


repeatmasker  %>% 
   mutate(repClass=factor(repClass)) %>% 
count(repClass) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repClass = fct_rev(fct_inorder(repClass))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repClass)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = paste0(repClass,"\n",sprintf("%.2f",perc*100),"%")),
                     position = position_stack(vjust = .5),
                     force=.9,show.legend = FALSE,max.overlaps = 35) +
  theme_void()+
  ggtitle("Human genome TE breakdown", subtitle=paste(length(repeatmasker$milliIns)))+
  scale_fill_repeat()


repeatmasker  %>% 
   mutate(repClass=factor(repClass)) %>% 
count(repClass) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repClass = fct_rev(fct_inorder(repClass))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repClass)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  # geom_label_repel(aes(label = paste0(repClass,"\n",sprintf("%.2f",perc*100),"%")),
  #                    position = position_stack(vjust = .5),
  #                    force=.9,show.legend = FALSE,max.overlaps = 35) +
  theme_void()+
  ggtitle("Human genome TE breakdown without labels", subtitle=paste(length(repeatmasker$milliIns)))+
  scale_fill_repeat()
```
#### Line repeats
```{r LINEclass breakdown}

Line_df <- Line_repeats %>% 
  as.data.frame() %>% 
  mutate(repFamily=factor(repFamily))

scale_fill_lines <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7",
                             "#FFFFB3",
                             "#BEBADA" ,
                             "#FB8072",
                             "#80B1D3",
                             "#FDB462",
                             "#B3DE69",
                             "#FCCDE5",
                             "#D9D9D9",
                             "#BC80BD",
                             "#CCEBC5",
                             "pink4",
                             "cornflowerblue",
                             "chocolate",
                             "brown",
                             "green",
                             "yellow4",
                             "purple",
                             "darkorchid4",
                             "coral4",
                             "darkolivegreen4",
                             "darkorange"), unique(Line_df$repFamily)), 
      ...
    )
}

Line_df%>% 
count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = paste0(repFamily,"\n",sprintf("%.2f",perc*100),"%")),
                     position = position_stack(vjust = .5),
                     force=.9,show.legend = FALSE,max.overlaps = 35) +
  theme_void()+
  ggtitle("Human genome LINE breakdown", subtitle=paste(length(Line_df$milliIns)))+
  scale_fill_lines()


Line_df%>% 
count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  theme_void()+
  ggtitle("Human genome LINE breakdown without labels", subtitle=paste(length(Line_df$milliIns)))+
  scale_fill_lines()

TE_LINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(TEstatus =="TE_peak"&repClass=="LINE") %>% 
  count

TE_mrc_status_list %>% 
  dplyr::filter(repClass == "LINE") %>% 
   mutate(repFamily=factor(repFamily)) %>% 
     group_by(repFamily) %>% 
  count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("LINE breakdown of peaks",subtitle=paste(TE_LINE_count$n))+
  scale_fill_lines()

EAR_LINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="EAR"&repClass=="LINE") %>% 
  count
ESR_LINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="LINE") %>% 
  count
LR_LINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="LINE") %>% 
  count
NR_LINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="LINE") %>% 
  count

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="EAR"&repClass=="LINE") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("EAR LINE breakdown of peaks",subtitle=paste(EAR_LINE_count$n))+
  scale_fill_lines()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="LINE") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("ESR LINE breakdown of peaks",subtitle=paste(ESR_LINE_count$n))+
  scale_fill_lines()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="LINE") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("LR LINE breakdown of peaks",subtitle=paste(LR_LINE_count$n))+
  scale_fill_lines()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="LINE") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("NR LINE breakdown of peaks",subtitle=paste(NR_LINE_count$n))+
  scale_fill_lines()

```
#### Sine repeats
```{r Sineclass breakdown, out.width="50%"}
Sine_df <- Sine_repeats %>% 
  as.data.frame() %>% 
  mutate(repFamily=factor(repFamily))

scale_fill_sines <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7",
                             "#FFFFB3",
                             "#BEBADA" ,
                             "#FB8072",
                             "#80B1D3",
                             "#FDB462",
                             "#B3DE69",
                             "#FCCDE5",
                             "#D9D9D9",
                             "#BC80BD",
                             "#CCEBC5",
                             "pink4",
                             "cornflowerblue",
                             "chocolate",
                             "brown",
                             "green",
                             "yellow4",
                             "purple",
                             "darkorchid4",
                             "coral4",
                             "darkolivegreen4",
                             "darkorange"), unique(Sine_df$repFamily)), 
      ...
    )
}

Sine_df%>% 
count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = paste0(repFamily,"\n",sprintf("%.2f",perc*100),"%")),
                     position = position_stack(vjust = .5),
                     force=.9,show.legend = FALSE,max.overlaps = 35) +
  theme_void()+
  ggtitle("Human genome SINE breakdown", subtitle=paste(length(Sine_df$milliIns)))+
  scale_fill_sines()


Sine_df%>% 
count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  theme_void()+
  ggtitle("Human genome SINE breakdown without labels", subtitle=paste(length(Sine_df$milliIns)))+
  scale_fill_sines()


TE_SINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(TEstatus =="TE_peak"&repClass=="SINE") %>% 
  count

TE_mrc_status_list %>% 
  dplyr::filter(repClass == "SINE") %>% 
   mutate(repFamily=factor(repFamily)) %>% 
     group_by(repFamily) %>% 
  count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("SINE breakdown of peaks",subtitle=paste(TE_SINE_count$n," total SINEs found"))+
  scale_fill_sines()



EAR_SINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="EAR"&repClass=="SINE") %>% 
  count
ESR_SINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="SINE") %>% 
  count
LR_SINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="SINE") %>% 
  count
NR_SINE_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="SINE") %>% 
  count

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="EAR"&repClass=="SINE") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("EAR SINE breakdown of peaks",subtitle=paste(EAR_SINE_count$n))+
  scale_fill_sines()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="SINE") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("ESR SINE breakdown of peaks",subtitle=paste(ESR_SINE_count$n))+
  scale_fill_sines()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="SINE") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("LR SINE breakdown of peaks",subtitle=paste(LR_SINE_count$n))+
  scale_fill_sines()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="SINE") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("NR SINE breakdown of peaks",subtitle=paste(NR_SINE_count$n))+
  scale_fill_sines()


```
#### LTR repeats
```{r LTR breakdown}

LTR_df <- LTR_repeats %>% 
  as.data.frame() %>% 
  mutate(repFamily=factor(repFamily))

scale_fill_LTRs <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7",
                             "#FFFFB3",
                             "#BEBADA" ,
                             "#FB8072",
                             "#80B1D3",
                             "#FDB462",
                             "#B3DE69",
                             "#FCCDE5",
                             "#D9D9D9",
                             "#BC80BD",
                             "#CCEBC5",
                             "pink4",
                             "cornflowerblue",
                             "chocolate",
                             "brown",
                             "green",
                             "yellow4",
                             "purple",
                             "darkorchid4",
                             "coral4",
                             "darkolivegreen4",
                             "darkorange"), unique(LTR_df$repFamily)), 
      ...
    )
}

LTR_df%>% 
count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = paste0(repFamily,"\n",sprintf("%.2f",perc*100),"%")),
                     position = position_stack(vjust = .5),
                     force=.9,show.legend = FALSE,max.overlaps = 35) +
  theme_void()+
  ggtitle("Human genome LTR breakdown", subtitle=paste(length(LTR_df$milliIns)))+
  scale_fill_LTRs()


LTR_df%>% 
count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  theme_void()+
  ggtitle("Human genome LTR breakdown without labels", subtitle=paste(length(LTR_df$milliIns)))+
  scale_fill_LTRs()


EAR_LTR_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="EAR"&repClass=="LTR") %>% 
  count
ESR_LTR_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="LTR") %>% 
  count
LR_LTR_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="LTR") %>% 
  count
NR_LTR_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="LTR") %>% 
  count

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="EAR"&repClass=="LTR") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("EAR LTR breakdown of peaks",subtitle=paste(EAR_LTR_count$n))+
  scale_fill_LTRs()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="LTR") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("ESR LTR breakdown of peaks",subtitle=paste(ESR_LTR_count$n))+
  scale_fill_LTRs()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="LTR") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("LR LTR breakdown of peaks",subtitle=paste(LR_LTR_count$n))+
  scale_fill_LTRs()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="LTR") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("NR LTR breakdown of peaks",subtitle=paste(NR_LTR_count$n))+
  scale_fill_LTRs()




```
#### DNA TEs

```{r DNA breakdown}
DNA_df <- DNA_repeats %>% 
  as.data.frame() %>% 
  mutate(repFamily=factor(repFamily))
DNA_df %>% distinct(repFamily)

scale_fill_DNAs <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7",
                             "#FFFFB3",
                             "#BEBADA" ,
                             "#FB8072",
                             "#80B1D3",
                             "#FDB462",
                             "#B3DE69",
                             "#FCCDE5",
                             "#D9D9D9",
                             "#BC80BD",
                             "#CCEBC5",
                             "pink4",
                             "cornflowerblue",
                             "chocolate",
                             "brown",
                             "green",
                             "yellow4",
                             "purple",
                             "darkorchid4",
                             "coral4",
                             "darkolivegreen4",
                             "darkorange",
                             "blue",
                             "grey",
                             "lightgrey"), unique(DNA_df$repFamily)), 
      ...
    )
}


DNA_df%>% 
count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = paste0(repFamily,"\n",sprintf("%.2f",perc*100),"%")),
                     position = position_stack(vjust = .5),
                     force=.9,show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("Human genome DNA breakdown", subtitle=paste(length(DNA_df$milliIns)))+
  scale_fill_DNAs()


DNA_df%>% 
count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  theme_void()+
  ggtitle("Human genome DNA breakdown without labels", subtitle=paste(length(DNA_df$milliIns)))+
  scale_fill_DNAs()


TE_DNA_count <- TE_mrc_status_list %>% 
  dplyr::filter(TEstatus =="TE_peak"&repClass=="DNA") %>% 
  count

TE_mrc_status_list %>% 
  dplyr::filter(repClass == "DNA") %>% 
   mutate(repFamily=factor(repFamily)) %>% 
     group_by(repFamily) %>% 
  count(repFamily) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("DNA breakdown of peaks",subtitle=paste(TE_DNA_count$n))+
  scale_fill_DNAs()


EAR_DNA_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="EAR"&repClass=="DNA") %>% 
  count
ESR_DNA_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="DNA") %>% 
  count
LR_DNA_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="DNA") %>% 
  count
NR_DNA_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="DNA") %>% 
  count

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="EAR"&repClass=="DNA") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("EAR DNA breakdown of peaks",subtitle=paste(EAR_DNA_count$n))+
  scale_fill_DNAs()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="DNA") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("ESR DNA breakdown of peaks",subtitle=paste(ESR_DNA_count$n))+
  scale_fill_DNAs()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="DNA") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("LR DNA breakdown of peaks",subtitle=paste(LR_DNA_count$n))+
  scale_fill_DNAs()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="DNA") %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  group_by(repFamily) %>% 
  count(repFamily) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
  mutate(repFamily = fct_rev(fct_inorder(repFamily))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repFamily)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("NR DNA breakdown of peaks",subtitle=paste(NR_DNA_count$n))+
  scale_fill_DNAs()

```

#### retroposon
```{r retroposon breakdown}

retroposon_df <- retroposon_repeats %>% 
  as.data.frame() %>% 
  mutate(repName=factor(repName))

length(unique(retroposon_df$repName))

scale_fill_retroposons <-  function(...){
    ggplot2:::manual_scale(
        'fill', 
        values = setNames(c( "#8DD3C7",
                             "#FFFFB3",
                             "#BEBADA" ,
                             "#FB8072",
                             "#80B1D3",
                             "#FDB462",
                             "#B3DE69",
                             "#FCCDE5",
                             "#D9D9D9",
                             "#BC80BD",
                             "#CCEBC5",
                             "pink4",
                             "cornflowerblue",
                             "chocolate",
                             "brown",
                             "green",
                             "yellow4",
                             "purple",
                             "darkorchid4",
                             "coral4",
                             "darkolivegreen4",
                             "darkorange"), unique(retroposon_df$repName)), 
      ...
    )
}

retroposon_df%>% 
count(repName) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repName = fct_rev(fct_inorder(repName))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repName)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = paste0(repName,"\n",sprintf("%.2f",perc*100),"%")),
                     position = position_stack(vjust = .5),
                     force=.9,show.legend = FALSE,max.overlaps = 35) +
  theme_void()+
  ggtitle("Human genome retroposon breakdown", subtitle=paste(length(retroposon_df$milliIns)))+
  scale_fill_retroposons()


retroposon_df%>% 
count(repName) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repName = fct_rev(fct_inorder(repName))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
   ggplot(., aes(x = "", y = n, fill = repName)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  theme_void()+
  ggtitle("Human genome retroposon breakdown without labels", subtitle=paste(length(retroposon_df$milliIns)))+
  scale_fill_retroposons()

TE_retroposon_count <- TE_mrc_status_list %>% 
  dplyr::filter(TEstatus =="TE_peak"&repClass=="Retroposon") %>% 
  count

TE_mrc_status_list %>% 
  dplyr::filter(repClass == "Retroposon") %>% 
   mutate(repName=factor(repName)) %>% 
     group_by(repName) %>% 
  count(repName) %>% 
   mutate(perc= n/sum(n)) %>% 
   arrange(desc(n)) %>% 
  mutate(repName = fct_rev(fct_inorder(repName))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repName)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
   # geom_label(aes(label = repClass),
   #          position = position_stack(vjust = .8)) +
  # geom_label(aes(label=repClass, y=text_y))
   geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("retroposon breakdown of peaks",subtitle=paste(TE_retroposon_count$n))+
  scale_fill_retroposons()

EAR_Retroposon_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="EAR"&repClass=="Retroposon") %>% 
  count
ESR_Retroposon_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="Retroposon") %>% 
  count
LR_Retroposon_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="Retroposon") %>% 
  count
NR_Retroposon_count <- TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="Retroposon") %>% 
  count

# TE_mrc_status_list %>% 
#   dplyr::filter(mrc =="EAR"&repClass=="Retroposon") %>% 
#   mutate(repName=factor(repName)) %>% 
#   group_by(repName) %>% 
#   count(repName) %>% 
#   mutate(perc= n/sum(n)) %>% 
#   arrange(desc(n)) %>% 
#    mutate(repName = fct_rev(fct_inorder(repName))) %>% 
#   mutate(text_y = cumsum(n) - n/2) %>% 
#   ggplot(., aes(x = "", y = n, fill = repFamily)) +
#   geom_col(color = "black") +
#   coord_polar(theta = "y", start = 0)+
#   geom_label_repel(aes(label = n),
#                      position = position_stack(vjust = .3),
#                      show.legend = FALSE,max.overlaps = 50) +
#   theme_void()+
#   ggtitle("EAR Retroposon breakdown of peaks",subtitle=paste(EAR_Retroposon_count$n))+
#   scale_fill_retroposons()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="ESR"&repClass=="Retroposon") %>% 
  mutate(repName=factor(repName)) %>% 
  group_by(repName) %>% 
  count(repName) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
   mutate(repName = fct_rev(fct_inorder(repName))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repName)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("ESR Retroposon breakdown of peaks",subtitle=paste(ESR_Retroposon_count$n))+
  scale_fill_retroposons()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="LR"&repClass=="Retroposon") %>% 
  mutate(repName=factor(repName)) %>% 
  group_by(repName) %>% 
  count(repName) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
   mutate(repName = fct_rev(fct_inorder(repName))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repName)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("LR Retroposon breakdown of peaks",subtitle=paste(LR_Retroposon_count$n))+
  scale_fill_retroposons()

TE_mrc_status_list %>% 
  dplyr::filter(mrc =="NR"&repClass=="Retroposon") %>% 
  mutate(repName=factor(repName)) %>% 
  group_by(repName) %>% 
  count(repName) %>% 
  mutate(perc= n/sum(n)) %>% 
  arrange(desc(n)) %>% 
   mutate(repName = fct_rev(fct_inorder(repName))) %>% 
  mutate(text_y = cumsum(n) - n/2) %>% 
  ggplot(., aes(x = "", y = n, fill = repName)) +
  geom_col(color = "black") +
  coord_polar(theta = "y", start = 0)+
  geom_label_repel(aes(label = n),
                     position = position_stack(vjust = .3),
                     show.legend = FALSE,max.overlaps = 50) +
  theme_void()+
  ggtitle("NR Retroposon breakdown of peaks",subtitle=paste(NR_Retroposon_count$n))+
  scale_fill_retroposons()


```




```{r breakdown by cluster}
 
ggline_df <- Line_repeats %>% 
  as.data.frame() %>% 
 unite(peakid,seqnames:end, sep= ".") %>% 
  dplyr::select(peakid,repName,repClass, repFamily,width) %>% 
  mutate(TEstatus ="TE_peak", mrc="h.genome") %>% 
    rbind(TE_mrc_status_list %>% dplyr::filter(repClass=="LINE") %>% mutate(mrc="all_peaks"))
 
  

ggsine_df <-
  Sine_repeats %>% 
  as.data.frame() %>% 
 unite(peakid,seqnames:end, sep= ".") %>% 
  dplyr::select(peakid,repName,repClass, repFamily,width) %>% 
  mutate(TEstatus ="TE_peak", mrc="h.genome") %>% 
    rbind(TE_mrc_status_list %>% dplyr::filter(repClass=="SINE") %>% mutate(mrc="all_peaks"))

ggLTR_df <-LTR_repeats %>% 
  as.data.frame() %>% 
 unite(peakid,seqnames:end, sep= ".") %>% 
  dplyr::select(peakid,repName,repClass, repFamily,width) %>% 
  mutate(TEstatus ="TE_peak", mrc="h.genome")%>% 
    rbind(TE_mrc_status_list %>% dplyr::filter(repClass=="LTR") %>% mutate(mrc="all_peaks"))


ggDNA_df <-DNA_repeats %>% 
  as.data.frame() %>% 
 unite(peakid,seqnames:end, sep= ".") %>% 
  dplyr::select(peakid,repName,repClass, repFamily,width) %>% 
  mutate(TEstatus ="TE_peak", mrc="h.genome")%>% 
    rbind(TE_mrc_status_list %>% dplyr::filter(repClass=="DNA") %>% mutate(mrc="all_peaks"))


ggretroposon_df <-retroposon_repeats %>% 
  as.data.frame() %>% 
 unite(peakid,seqnames:end, sep= ".") %>% 
  dplyr::select(peakid,repName,repClass, repFamily,width) %>% 
  mutate(TEstatus ="TE_peak", mrc="h.genome")%>% 
    rbind(TE_mrc_status_list %>% dplyr::filter(repClass=="Retroposon") %>% mutate(mrc="all_peaks"))


TE_mrc_status_list %>% 
  dplyr::filter(repClass=="LINE") %>% 
  dplyr::filter(mrc != "not_mrc") %>% 
  rbind(., ggline_df) %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  mutate(mrc=factor(mrc, levels = c("EAR","ESR", "LR", "NR","all_peaks","h.genome"))) %>% 
  ggplot(., aes(x=mrc, fill= repFamily))+
  geom_bar(position="fill", col="black")+
  theme_bw()+
  ggtitle("LINE breakdown by MRC and Family")+
  scale_fill_lines()
TE_mrc_status_list %>% 
  dplyr::filter(repClass=="SINE") %>% 
  dplyr::filter(mrc != "not_mrc") %>% 
   rbind(., ggsine_df) %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  mutate(mrc=factor(mrc, levels = c("EAR","ESR", "LR", "NR","all_peaks","h.genome"))) %>% 
  ggplot(., aes(x=mrc, fill= repFamily))+
  geom_bar(position="fill", col="black")+
  theme_bw()+
  ggtitle("SINE breakdown by MRC and Family")+
  scale_fill_sines()

TE_mrc_status_list %>% 
  dplyr::filter(repClass=="LTR") %>% 
  dplyr::filter(mrc != "not_mrc") %>% 
   rbind(., ggLTR_df) %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  mutate(mrc=factor(mrc, levels = c("EAR","ESR", "LR", "NR","all_peaks","h.genome"))) %>% 
  ggplot(., aes(x=mrc, fill= repFamily))+
  geom_bar(position="fill", col="black")+
  theme_bw()+
  ggtitle("LTR breakdown by MRC and Family")+
  scale_fill_LTRs()

TE_mrc_status_list %>% 
  dplyr::filter(repClass=="DNA") %>% 
  dplyr::filter(mrc != "not_mrc") %>% 
   rbind(., ggDNA_df) %>% 
  mutate(repFamily=factor(repFamily)) %>% 
  mutate(mrc=factor(mrc, levels = c("EAR","ESR", "LR", "NR","all_peaks","h.genome"))) %>% 
  ggplot(., aes(x=mrc, fill= repFamily))+
  geom_bar(position="fill", col="black")+
  theme_classic()+
  ggtitle("DNA breakdown by MRC and Family")+
  scale_fill_DNAs()

TE_mrc_status_list %>% 
  dplyr::filter(repClass=="Retroposon") %>% 
  dplyr::filter(mrc != "not_mrc") %>% 
   rbind(., ggretroposon_df) %>% 
  mutate(repName=factor(repName)) %>% 
  mutate(mrc=factor(mrc, levels = c("EAR","ESR", "LR", "NR","all_peaks","h.genome"))) %>% 
  ggplot(., aes(x=mrc, fill= repName))+
  geom_bar(position="fill", col="black")+
  theme_classic()+
  ggtitle("Retroposon breakdown by MRC and Family")+
  scale_fill_retroposons()
    
```

### CG islands! 
```{r cgisland load}

cpgislands_df <- read.delim("data/other_papers/cpg_islands.tsv")

cpg_island_gr <- cpgislands_df %>% 
 makeGRangesFromDataFrame(., keep.extra.columns = TRUE, seqnames.field = "chrom", start.field = "chromStart", end.field = "chromEnd",starts.in.df.are.0based=TRUE)

Col_fullDF_cug_overlap <- join_overlap_intersect(Col_TSS_data_gr,cpg_island_gr)
Col_fullDF_cug_overlap %>% 
  as.data.frame() %>% 
  # group_by(repClass) %>%  
  tally %>% 
  kable(., caption="Count of peaks with CG islands") %>% 
  kable_paper("striped", full_width = TRUE) %>%
  kable_styling(full_width = FALSE, font_size = 14)
  
hits_cpg <- findOverlaps(Col_TSS_data_gr,cpg_island_gr)
overlaps_cpg <- pintersect(Col_TSS_data_gr[queryHits(hits_cpg)], cpg_island_gr[subjectHits(hits_cpg)])
percentOverlap_cpg <- width(overlaps_cpg) / width(cpg_island_gr[subjectHits(hits_cpg)])
hits_cpg <- hits_cpg[percentOverlap_cpg > 0.5]

testingol_cpg <- Col_TSS_data_gr[queryHits(hits_cpg)]

CUG_mrc_status_list <-    testingol_cpg %>% as.data.frame() %>%
  left_join(., (Col_fullDF_cug_overlap %>% as.data.frame(.)), by =c("seqnames"="seqnames","start"="start","end"="end","peakid"="peakid", "NCBI_gene"="NCBI_gene", "ensembl_ID"="ensembl_ID","dist_to_NG"="dist_to_NG",  "SYMBOL" = "SYMBOL","width"="width")) %>% 
    dplyr::select(peakid, name,cpgNum:obsExp) %>% 
  mutate(cugstatus=if_else(is.na(cpgNum),"not_CGi_peak","CGi_peak")) %>% 
   mutate(mrc=if_else(peakid %in% EAR_df$id, "EAR",
                     if_else(peakid %in% ESR_df$id,"ESR",
                             if_else(peakid %in% LR_df$id,"LR",
                                     if_else(peakid %in% NR_df$id,"NR","not_mrc"))))) 

CUG_mrc_status_list %>% 
 group_by(cugstatus, mrc) %>% 
 count

CUG_mrc_status_list %>% 
  mutate(mrc=factor(mrc, levels = c("NR", "EAR", "ESR","LR","not_mrc"))) %>%
  group_by(cugstatus, mrc) %>% 
  ggplot(., aes(x = mrc,  fill = cugstatus)) +
  geom_bar(position="fill",color = "black")+
  theme_bw()+
  ggtitle("CG islands by mrc", subtitle=paste(length(CUG_mrc_status_list$peakid )))
  
CUG_mrc_status_list %>% 
  mutate(mrc="full_list") %>% 
  rbind(., CUG_mrc_status_list) %>% 
   mutate(mrc=factor(mrc, levels=c("EAR","ESR","LR","NR","not-mrc","full_list"))) %>% 
  dplyr::filter(mrc !="not_mrc") %>% 
  group_by(cugstatus, mrc) %>% 
  ggplot(., aes(x = mrc,  fill = cugstatus)) +
  geom_bar(position="fill",color = "black")+
  theme_bw()+
  ggtitle("CG islands by mrc", subtitle=paste(length(CUG_mrc_status_list$peakid )))
  

CUG_mrc_status_list %>% 
   mutate(mrc=factor(mrc, levels=c("EAR","ESR","LR","NR","not-mrc"))) %>% 
 group_by(peakid) %>% 
  distinct( peakid,cugstatus,mrc) %>% 
   ungroup %>%
  summarise(pval = chisq.test(mrc, cugstatus)$p.value)
      
Col_fullDF_cug_overlap %>% 
        as.data.frame %>% 
        ggplot(., aes (x = width))+
        geom_density(color="darkblue",fill="lightblue",aes(alpha = 0.5))+
  theme_classic()+
  ggtitle("density widths of CGisland overlap",subtitle = " limited x axis")+
  coord_cartesian(xlim= c(0,2500))
cpg_island_gr %>% 
  as.data.frame() %>% 
  ggplot(., aes (x = width))+
        geom_density(aes(alpha = 0.5))+
  theme_classic()+
  ggtitle("density widths of CGislands ",subtitle = " limited x axis")#+
  coord_cartesian(xlim= c(0,2500))
  
```

##### This code is for making peak lists for GO and MEME analysis:
```{r peak lists}
# CUG_mrc_status_list

notTE_NR <- TE_mrc_status_list %>% 
  separate_wider_delim(col="peakid",".", 
                       names= c("seqnames","start","end"), 
                       cols_remove = FALSE) %>%
  dplyr::filter(mrc !="not_mrc") %>% 
  dplyr::filter(TEstatus=="not_TE_peak" & mrc =="NR")

notTE_EAR <- TE_mrc_status_list %>% 
  separate_wider_delim(col="peakid",".", 
                       names= c("seqnames","start","end"), 
                       cols_remove = FALSE) %>%
  dplyr::filter(mrc !="not_mrc") %>% 
  dplyr::filter(TEstatus=="not_TE_peak" & mrc =="EAR")

notTE_ESR <- TE_mrc_status_list %>% 
  separate_wider_delim(col="peakid",".", 
                       names= c("seqnames","start","end"), 
                       cols_remove = FALSE) %>%
  dplyr::filter(mrc !="not_mrc") %>% 
  dplyr::filter(TEstatus=="not_TE_peak" & mrc =="ESR")

notTE_LR <- TE_mrc_status_list %>% 
  separate_wider_delim(col="peakid",".", 
                       names= c("seqnames","start","end"), 
                       cols_remove = FALSE) %>%
  dplyr::filter(mrc !="not_mrc") %>% 
  dplyr::filter(TEstatus=="not_TE_peak" & mrc =="LR")


  
```
### SNP
```{r SNPnPeaknTE}

gwas_ACtox <- readRDS("data/gwas_1_dataframe.RDS")  
gwas_ARR <- readRDS("data/gwas_2_dataframe.RDS")
gwas_ACresp <- readRDS("data/gwas_3_dataframe.RDS")
gwas_HD <- readRDS("data/gwas_4_dataframe.RDS")
gwas_HF <- readRDS("data/gwas_5_dataframe.RDS")
gwas_CAD <- readRDS( "data/CAD_gwas_dataframe.RDS")
gwas_MI <- readRDS("data/MI_gwas.RDS")

gwas_snp_list <- gwas_ACtox %>%
  distinct(SNPS,.keep_all = TRUE) %>% 
  dplyr::select(CHR_ID, CHR_POS,SNPS) %>% 
  mutate(gwas="ACtox") %>% 
  rbind(gwas_ARR %>% 
          distinct(SNPS,.keep_all = TRUE) %>%
          dplyr::select(CHR_ID, CHR_POS,SNPS) %>% 
          mutate(gwas="ARR")) %>% 
  rbind(gwas_ACresp %>% 
          distinct(SNPS,.keep_all = TRUE) %>%
          dplyr::select(CHR_ID, CHR_POS,SNPS) %>% 
          mutate(gwas="ACresp")) %>% 
  rbind(gwas_HD %>% 
          distinct(SNPS,.keep_all = TRUE) %>%
          dplyr::select(CHR_ID, CHR_POS,SNPS) %>% 
          mutate(gwas="HD")) %>% 
  rbind(gwas_HF %>% 
          distinct(SNPS,.keep_all = TRUE) %>%
          dplyr::select(CHR_ID, CHR_POS,SNPS) %>% 
          mutate(gwas="HF")) %>% 
  rbind(gwas_CAD %>% 
          distinct(SNPS,.keep_all = TRUE) %>%
          dplyr::select(CHR_ID, CHR_POS,SNPS) %>% 
          mutate(gwas="CAD")) %>% 
  rbind(gwas_MI %>% 
          distinct(SNPS,.keep_all = TRUE) %>%
          dplyr::select(CHR_ID, CHR_POS,SNPS) %>% 
          mutate(gwas="MI"))

gwas_snp_gr <- gwas_snp_list %>% 
   mutate(CHR_ID=as.numeric(CHR_ID), CHR_POS=as.numeric(CHR_POS)) %>% 
  na.omit() %>% 
   mutate(start=CHR_POS, end=CHR_POS, chr=paste0("chr",CHR_ID)) %>% 
  GRanges()

findOverlaps(gwas_snp_gr, all_TEs_gr)
test <- join_overlap_intersect(gwas_snp_gr, all_TEs_gr) %>% GRanges
##3413

test_new <-  test %>% 
   as.data.frame %>% 
   dplyr::select (seqnames:gwas,repName:repFamily) %>% 
   GRanges()
peaks <-
  Collapsed_peaks %>% 
    dplyr::select(seqnames:peakid) %>% 
    GRanges()
peak_test <- join_overlap_intersect(test_new, peaks)

peak_test

Col_fullDF_overlap %>% 
  as.data.frame %>% 
  dplyr::select(seqnames:peakid,repName:repFamily) %>% 
  GRanges() %>% 
  join_overlap_intersect(.,gwas_snp_gr)

test2 <- join_overlap_intersect(peaks, gwas_snp_gr) 
  
test2 %>% 
   join_overlap_intersect(., all_TEs_gr) %>% 
  as.data.frame %>% 
  dplyr::select(seqnames:gwas,repName:repFamily) %>% 
  mutate(mrc=if_else(peakid %in% EAR_df$id, "EAR",
                     if_else(peakid %in% ESR_df$id,"ESR",
                             if_else(peakid %in% LR_df$id,"LR",
                                     if_else(peakid %in% NR_df$id,"NR","not_mrc"))))) %>% 
  # distinct(peakid, .keep_all = TRUE) %>% 
  group_by(gwas,mrc) %>% 
  tally


```

