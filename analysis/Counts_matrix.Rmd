---
title: "Counts_matrix"
author: "Renee Matthews"
date: "2025-05-06"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	dev = c("png","pdf")
)
```

```{css, echo=FALSE}
pre {
  max-height: 400px;
  overflow-y: auto;
}

pre[class] {
  max-height: 200px;
}
```

```{r packages}
library(tidyverse)
library(kableExtra)
library(broom)
library(RColorBrewer)
library(ChIPseeker)
library("TxDb.Hsapiens.UCSC.hg38.knownGene")
library("org.Hs.eg.db")
library(rtracklayer)
library(edgeR)
library(ggfortify)
library(limma)
library(readr)
library(BiocGenerics)
library(gridExtra)
library(VennDiagram)
library(scales)
library(BiocParallel)
library(ggpubr)
library(devtools)
library(eulerr)
# library(genomation)
library(ggsignif)
library(plyranges)
library(ggrepel)
library(ComplexHeatmap)
library(cowplot)
library(smplot2)
library(data.table)


```
```{r functions}
drug_pal <- c("#8B006D","#DF707E","#F1B72B", "#3386DD","#707031","#41B333")


prop_var_percent <- function(pca_result){ 
  # Ensure the input is a PCA result object
  if (!inherits(pca_result, "prcomp")) {
    stop("Input must be a result from prcomp()")
  }
  
  # Get the standard deviations from the PCA result
  sdev <- pca_result$sdev
  
  # Calculate the proportion of variance
  proportion_variance <- (sdev^2) / sum(sdev^2)*100
  
  return(proportion_variance)
}

```

## Examining the counts matrix:

This section is using the featureCounts matrix of the 172,481 high confidence peaks across all samples called "all_four_filtered_counts.txt".

```{r}
### Load the table
all_four_filt_counts <- read.delim("data/all_four_filtered_counts.txt",header=TRUE) %>% 
  GRanges() %>% 
  keepStandardChromosomes(pruning.mode = "coarse") %>% 
  as.data.frame() 
##remove tail from column names
names(all_four_filt_counts) = gsub(pattern = "_S.*", replacement = "", x = names(all_four_filt_counts))
### remove directory from individual file names
names(all_four_filt_counts) = gsub(pattern = "ind1.trimmed.filt_files.trimmed_|ind2.trimmed.filt_files.trimmed_|ind3.trimmed.filt_files.trimmed_|ind6.trimmed.filt_files.trimmed_", replacement = "", x = names(all_four_filt_counts))

```

The number of peaks from master peak set: `r length(all_four_filt_counts$Geneid)` peaks

### Looking at the counts matrix
```{r rawcounts, fig.width=8, fig.height=7}
raw_counts <- all_four_filt_counts %>% 
  dplyr::select(Geneid,Ind1_75DA24h:Ind6_71V3h) %>% 
  column_to_rownames("Geneid") %>% 
  rename_with(.,~gsub(pattern = "Ind1_75", replacement = "D_",.)) %>% 
  rename_with(.,~gsub(pattern = "Ind2_87", replacement = "A_",.)) %>%
  rename_with(.,~gsub(pattern = "Ind3_77", replacement = "B_",.)) %>%
  rename_with(.,~gsub(pattern = "Ind6_71", replacement = "C_",.)) %>%
  rename_with(.,~gsub( "DX" ,'DOX',.)) %>%
  rename_with(.,~gsub( "DA" ,'DNR',.)) %>%
  rename_with(.,~gsub( "E" ,'EPI',.)) %>%
  rename_with(.,~gsub( "T" ,'TRZ',.)) %>%
  rename_with(.,~gsub( "M" ,'MTX',.)) %>%
  rename_with(.,~gsub( "V" ,'VEH',.)) %>%
  rename_with(.,~gsub("24h","_24h",.)) %>%
  rename_with(.,~gsub("3h","_3h",.)) %>%
  as.matrix()
  
hist(raw_counts, main= "Raw counts across samples",
     xlab = "Raw counts",
     col=4)
hist(cpm(raw_counts, log=TRUE), 
     main = expression("Histogram of Log"[2]*" cpm unfiltered"),
     xlab = expression("Log"[2]*" counts-per-million"),
     col=4)

boxplot(cpm(raw_counts, log=TRUE),
        main=expression("Boxplot of Log"[2]*" counts-per-million"),
                        col=4,
        names=colnames(raw_counts),
        las=2, cex.axis=.7)

```
Saving a .tsv of the raw unfiltered counts:
```{r save raw unfiltered counts, eval=FALSE}
raw_counts %>% 
  as.data.frame() %>% 
  rownames_to_column("Peakid") %>% 
  write_delim(., "data/Final_four_data/re_analysis/Raw_unfiltered_counts.tsv",delim="\t")

```


### Heatmap of unfiltered log2 cpm counts


```{r full heatmap, fig.width=10, fig.height=10}
cor_raw_counts <- raw_counts %>% 
  cpm(., log = TRUE) %>% 
  cor(.,method = "pearson")

anno_raw_counts <- data.frame(timeset = colnames(cor_raw_counts))

counts_corr_mat <-anno_raw_counts %>%
  separate(timeset, into = c("indv","trt","time"), sep= "_") %>% 
  mutate(class = if_else(trt == "DNR", "AC", 
                         if_else(trt == "DOX", "AC", 
                                 if_else(trt == "EPI", "AC", "nAC")))) %>%
  mutate(TOP2i = if_else(trt == "DNR", "yes", 
                         if_else(trt == "DOX", "yes", 
                                 if_else(trt == "EPI", "yes", 
                                         if_else(trt == "MTX", "yes", "no"))))) 

                         
 mat_colors <- list( 
   trt= c("#F1B72B","#8B006D","#DF707E","#3386DD","#707031","#41B333"),
   indv=c("#1B9E77", "#D95F02" ,"#7570B3", "#E6AB02"),
   time=c("pink", "chocolate4"),
   class=c("yellow1","darkorange1"), 
   TOP2i =c("darkgreen","lightgreen"))                        
                         
names(mat_colors$trt)   <- unique(counts_corr_mat$trt)                      
names(mat_colors$indv) <- unique(counts_corr_mat$indv)
names(mat_colors$time) <- unique(counts_corr_mat$time)
names(mat_colors$class) <- unique(counts_corr_mat$class)
names(mat_colors$TOP2i) <- unique(counts_corr_mat$TOP2i)


htanno_full <-  ComplexHeatmap::HeatmapAnnotation(df = counts_corr_mat, col = mat_colors)
Heatmap(cor_raw_counts, top_annotation = htanno_full)


```


### Filtering out low counts

Using a log2cpm row_means>0, I filtered out the peaks with very low counts.  I discovered there were three Y-chromosome reads and also removed them.

```{r Filtering out lowcount peaks}
lcpm <- cpm(raw_counts, log= TRUE)
  ### for determining the basic cutoffs
filt_raw_counts <- raw_counts[rowMeans(lcpm)> 0,]
dim(filt_raw_counts)
tail(rownames(filt_raw_counts),n=10)

```
Looking at the data set, I found there were three Y chromosome peaks and removed them.



```{r remove Y}
filt_raw_counts_noY <- filt_raw_counts[!grepl("chrY",rownames(filt_raw_counts)),]
dim(filt_raw_counts_noY)
tail(filt_raw_counts_noY)
```

After verifying removal, I wanted to see the effect on boxplot and histogram of removed regions.

```{r}

hist(filt_raw_counts_noY, main= "Filtered raw counts across samples",
     xlab = "Raw counts",
     col=3)
hist(cpm(filt_raw_counts_noY, log=TRUE), 
     main = expression("Histogram of Log"[2]*" cpm filtered counts"),
     xlab = expression("Log"[2]*" counts-per-million"),
     col=3)

boxplot(cpm(filt_raw_counts_noY, log=TRUE),
        main=expression("Boxplot of Log"[2]*" counts-per-million filtered counts"),
                        col=3,
        names=colnames(raw_counts),
        las=2, cex.axis=.7)
```


### PCA analysis

Now to look at the principle components of the data.

```{r PCA analysis of filtered counts}
##get log2cpm of raw filtered counts
filt4_matrix_lcpm <- cpm(filt_raw_counts_noY , log=TRUE)
## store PRcomp
PCA4_info_filter <- (prcomp(t(filt4_matrix_lcpm), scale. = TRUE))
###make annotation dataframe
annotation_mat <- data.frame(timeset=colnames(filt_raw_counts_noY)) %>%
  mutate(sample = timeset) %>% 
  separate(timeset, into = c("indv","trt","time"), sep= "_") %>% 
  mutate(time = factor(time, levels = c("3h", "24h"), labels= c("3 hours","24 hours"))) %>% 
  mutate(trt = factor(trt, levels = c("DOX","EPI", "DNR", "MTX", "TRZ", "VEH"))) 
### join together for plotting
pca_final_four_anno <- data.frame(annotation_mat, PCA4_info_filter$x)
plotting_var_names <- prop_var_percent(PCA4_info_filter)

pca_final_four_anno %>%
  ggplot(.,aes(x = PC1, y = PC2, col=trt, shape=time, group=indv))+
  geom_point(size= 5)+
  scale_color_manual(values=drug_pal)+
   ggrepel::geom_text_repel(aes(label = indv))+
   ggtitle(expression("PCA of log"[2]*"(cpm) filtered peak set"))+
  theme_bw()+
  guides(col="none", size =4)+
  labs(y = paste0("PC 2 (",round(plotting_var_names[2],1),"%)")
       , x =paste0("PC 1 (",round(plotting_var_names[1],1),"%)"))+
  theme(plot.title=element_text(size= 14,hjust = 0.5),
        axis.title = element_text(size = 12, color = "black"))

pca_final_four_anno %>%
  ggplot(.,aes(x = PC3, y = PC4, col=trt, shape=time, group=indv))+
  geom_point(size= 5)+
  scale_color_manual(values=drug_pal)+
   ggrepel::geom_text_repel(aes(label = indv))+
   ggtitle(expression("PCA of log"[2]*"(cpm) filtered peak set"))+
  theme_bw()+
  guides(col="none", size =4)+
  labs(y = paste0("PC 4 (",round(plotting_var_names[4],1),"%)")
       , x =paste0("PC 3 (",round(plotting_var_names[3],1),"%)"))+
  theme(plot.title=element_text(size= 14,hjust = 0.5),
        axis.title = element_text(size = 12, color = "black"))


```

