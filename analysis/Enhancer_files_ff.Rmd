---
title: "Enhancer_files"
author: "ERM"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
	
)
```

```{css, echo=FALSE}
pre {
  max-height: 400px;
  overflow-y: auto;
}

pre[class] {
  max-height: 200px;
}
```
####Loading
```{r package loading, message=FALSE, warning=FALSE}
library(tidyverse)
library(kableExtra)
library(broom)
library(RColorBrewer)
library(ChIPseeker)
library("TxDb.Hsapiens.UCSC.hg38.knownGene")
library("org.Hs.eg.db")
library(rtracklayer)
library(edgeR)
library(ggfortify)
library(limma)
library(readr)
library(BiocGenerics)
library(gridExtra)
library(VennDiagram)
library(scales)
# library(Cormotif)
library(BiocParallel)
library(ggpubr)
library(devtools)
library(JASPAR2022)
library(TFBSTools)
library(MotifDb)
library(BSgenome.Hsapiens.UCSC.hg38)
library(plyranges)
library(genomation)
library(gprofiler2)

```

Data loading

```{r data loading}
# toplistall_RNA <- readRDS("data/other_papers/toplistall_RNA.RDS") 
# S13Table <- read.csv( "data/other_papers/S13Table_Matthews2024.csv",row.names = 1)
# ##14021
# 
# EAR_RNA <- S13Table %>% 
#   dplyr::filter(MOTIF=="EAR") %>% 
#   dplyr::select(ENTREZID) %>% 
#   mutate(ENTREZID= as.character(ENTREZID))
# ESR_RNA <- S13Table %>% 
#   dplyr::filter(MOTIF=="ESR")%>% 
#   dplyr::select(ENTREZID)%>% 
#   mutate(ENTREZID= as.character(ENTREZID))
# LR_RNA <- S13Table %>% 
#   dplyr::filter(MOTIF=="LR")%>% 
#   dplyr::select(ENTREZID)%>% 
#   mutate(ENTREZID=as.character(ENTREZID))
# NR_RNA <- S13Table %>% 
#   dplyr::filter(MOTIF=="NR")%>% 
#   dplyr::select(ENTREZID)%>% 
#   mutate(ENTREZID= as.character(ENTREZID))

# exp_neargene_table <- read_delim("data/n45_bedfiles/exp_neargene_table.tsv", 
#     delim = "\t", escape_double = FALSE, 
#     trim_ws = TRUE)

TSS_NG_data <- read_delim("data/Final_four_data/TSS_assigned_NG.txt", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE)

col_ng_peak <- read.delim("data/Final_four_data/collapsed_new_peaks.txt")

peakAnnoList_ff_8motif <- readRDS("data/Final_four_data/peakAnnoList_ff_8motif.RDS")
# list2env(peakAnnoList_n45_motif, envir = .GlobalEnv)

# peakAnnoList_3_n45 <- readRDS("data/peakAnnoList_3_n45.RDS")
# peakAnnoList_24_n45<- readRDS("data/peakAnnoList_24_n45.RDS")

all_peak_gr <- as.GRanges(peakAnnoList_ff_8motif$background)

# Joined_tss_neargene <- all_peak_gr %>%
#   as.data.frame() %>% 
#   dplyr::select(seqnames:id,geneId,distanceToTSS) %>% 
#   dplyr::filter(!grepl("chrX",id)& !grepl("chrY",id))%>%
#   dplyr::rename("close_geneId"="geneId") %>% 
#   mutate(start=start+1) %>% 
#   left_join(., TSS_NG_data, by=c("id"="peakid", "start"="start","end"="end")) %>%
#   dplyr::select(seqnames.x:close_geneId,distanceToTSS, entrezgene_id:dist_to_NG)
  


EAR_open <- as.data.frame(peakAnnoList_ff_8motif$EAR_open)
EAR_open_gr <-  as.GRanges(peakAnnoList_ff_8motif$EAR_open)
EAR_close <- as.data.frame(peakAnnoList_ff_8motif$EAR_close)
EAR_close_gr <-  as.GRanges(peakAnnoList_ff_8motif$EAR_close)


ESR_open <- as.data.frame(peakAnnoList_ff_8motif$ESR_open)
ESR_open_gr <- as.GRanges(peakAnnoList_ff_8motif$ESR_open)
ESR_close <- as.data.frame(peakAnnoList_ff_8motif$ESR_close)
ESR_close_gr <- as.GRanges(peakAnnoList_ff_8motif$ESR_close)
ESR_OC <- as.data.frame(peakAnnoList_ff_8motif$ESR_OC)
ESR_OC_gr <- as.GRanges(peakAnnoList_ff_8motif$ESR_OC)


LR_open <- as.data.frame(peakAnnoList_ff_8motif$LR_open)
LR_open_gr <-  as.GRanges(peakAnnoList_ff_8motif$LR_open)
LR_close <- as.data.frame(peakAnnoList_ff_8motif$LR_close)
LR_close_gr <-  as.GRanges(peakAnnoList_ff_8motif$LR_close)

NR <- as.data.frame(peakAnnoList_ff_8motif$NR)
NR_gr <-  as.GRanges(peakAnnoList_ff_8motif$NR)

EAR_open_list_all <-  TSS_NG_data %>%
    dplyr::filter(Peakid %in% EAR_open$Peakid) %>% 
  mutate(MRC="EAR_open") %>% 
  distinct(Peakid,.keep_all = TRUE)
EAR_close_list_all <-  TSS_NG_data %>%
    dplyr::filter(Peakid %in% EAR_close$Peakid) %>% 
  mutate(MRC="EAR_close") %>% 
  distinct(Peakid,.keep_all = TRUE)

ESR_open_list_all <- TSS_NG_data %>%
    dplyr::filter(Peakid %in% ESR_open$Peakid) %>% 
    mutate(MRC="ESR_open")%>% 
  distinct(Peakid,.keep_all = TRUE)
ESR_close_list_all <- TSS_NG_data %>%
    dplyr::filter(Peakid %in% ESR_close$Peakid) %>% 
    mutate(MRC="ESR_close")%>% 
  distinct(Peakid,.keep_all = TRUE)
ESR_OC_list_all <- TSS_NG_data %>%
    dplyr::filter(Peakid %in% ESR_OC$Peakid) %>% 
    mutate(MRC="ESR_OC")%>% 
  distinct(Peakid,.keep_all = TRUE)

LR_open_list_all <- TSS_NG_data %>%
    dplyr::filter(Peakid %in% LR_open$Peakid) %>% 
    mutate(MRC="LR_open")%>% 
  distinct(Peakid,.keep_all = TRUE)
LR_close_list_all <- TSS_NG_data %>%
    dplyr::filter(Peakid %in% LR_close$Peakid) %>% 
    mutate(MRC="LR_close")%>% 
  distinct(Peakid,.keep_all = TRUE)

NR_list_all <- TSS_NG_data %>%
    dplyr::filter(Peakid %in% NR$Peakid) %>% 
    mutate(MRC="NR")%>% 
  distinct(Peakid,.keep_all = TRUE)

peak_list_all_mrc <- col_ng_peak %>% 
  mutate(mrc=if_else(Peakid %in% EAR_open$Peakid, "EAR_open",
                      if_else(Peakid %in% EAR_close$Peakid, "EAR_close",
                              if_else(Peakid %in% ESR_open$Peakid,"ESR_open",
                                      if_else(Peakid %in% ESR_close$Peakid,"ESR_close",
                                              if_else(Peakid %in% ESR_OC$Peakid,"ESR_OC",
                                                      if_else(Peakid %in% LR_open$Peakid,"LR_open",
                                                                      if_else(Peakid %in% LR_close$Peakid,"LR_close",
                                                                              if_else(Peakid %in% NR$Peakid,"NR","not_mrc"))))))))) 
  


EAR_open_NG_2k<-  peak_list_all_mrc %>% 
      dplyr::filter(mrc =="EAR_open") %>% 
    dplyr::filter(dist_to_NG >-2000&dist_to_NG<2000) %>% 
    dplyr::select(Peakid, NCBI_gene:SYMBOL,dist_to_NG, mrc) %>% 
    separate_longer_delim(., cols=NCBI_gene:SYMBOL, delim= ",") %>% 
    distinct(NCBI_gene,SYMBOL)
EAR_close_NG_2k<-  peak_list_all_mrc %>% 
      dplyr::filter(mrc =="EAR_close") %>% 
    dplyr::filter(dist_to_NG >-2000&dist_to_NG<2000) %>% 
    dplyr::select(Peakid, NCBI_gene:SYMBOL,dist_to_NG, mrc) %>% 
    separate_longer_delim(., cols=NCBI_gene:SYMBOL, delim= ",") %>% 
    distinct(NCBI_gene,SYMBOL)
  
ESR_open_NG_2k<-  peak_list_all_mrc %>% 
      dplyr::filter(mrc =="ESR_open") %>% 
    dplyr::filter(dist_to_NG >-2000&dist_to_NG<2000) %>% 
    dplyr::select(Peakid, NCBI_gene:SYMBOL,dist_to_NG, mrc) %>% 
    separate_longer_delim(., cols=NCBI_gene:SYMBOL, delim= ",") %>% 
    distinct(NCBI_gene,SYMBOL)
ESR_close_NG_2k<-  peak_list_all_mrc %>% 
      dplyr::filter(mrc =="ESR_close") %>% 
    dplyr::filter(dist_to_NG >-2000&dist_to_NG<2000) %>% 
    dplyr::select(Peakid, NCBI_gene:SYMBOL,dist_to_NG, mrc) %>% 
    separate_longer_delim(., cols=NCBI_gene:SYMBOL, delim= ",") %>% 
    distinct(NCBI_gene,SYMBOL)
ESR_OC_NG_2k<-  peak_list_all_mrc %>% 
      dplyr::filter(mrc =="ESR_OC") %>% 
    dplyr::filter(dist_to_NG >-2000&dist_to_NG<2000) %>% 
    dplyr::select(Peakid, NCBI_gene:SYMBOL,dist_to_NG, mrc) %>% 
    separate_longer_delim(., cols=NCBI_gene:SYMBOL, delim= ",") %>% 
    distinct(NCBI_gene,SYMBOL)

LR_open_NG_2k<-  peak_list_all_mrc %>% 
      dplyr::filter(mrc =="LR_open") %>% 
    dplyr::filter(dist_to_NG >-2000&dist_to_NG<2000) %>% 
    dplyr::select(Peakid, NCBI_gene:SYMBOL,dist_to_NG, mrc) %>% 
    separate_longer_delim(., cols=NCBI_gene:SYMBOL, delim= ",") %>% 
    distinct(NCBI_gene,SYMBOL)
LR_close_NG_2k<-  peak_list_all_mrc %>% 
      dplyr::filter(mrc =="LR_close") %>% 
    dplyr::filter(dist_to_NG >-2000&dist_to_NG<2000) %>% 
    dplyr::select(Peakid, NCBI_gene:SYMBOL,dist_to_NG, mrc) %>% 
    separate_longer_delim(., cols=NCBI_gene:SYMBOL, delim= ",") %>% 
    distinct(NCBI_gene,SYMBOL)

NR_NG_2k <-   peak_list_all_mrc %>%
      dplyr::filter(mrc =="NR") %>% 
    dplyr::filter(dist_to_NG >-2000&dist_to_NG<2000) %>% 
    dplyr::select(Peakid, NCBI_gene:SYMBOL,dist_to_NG, mrc) %>% 
    separate_longer_delim(., cols=NCBI_gene, delim= ",") %>% 
     separate_longer_delim(., cols=,SYMBOL, delim= ",")  
 
  

median_24_lfc <- read_csv("data/Final_four_data/median_24_lfc.csv") 
median_3_lfc <- read_csv("data/Final_four_data/median_3_lfc.csv")


# saveRDS(peak_list_all_mrc, "data/Final_four_data/Peak_list_all_mrc_NG.RDS")

Top2b_peaks_gr <- readBed("data/n45_bedfiles/TOP2B_CM.bed")

```

### Enhancers and Response clusters


First:  obtained a list of cis Regulatory Elements from Encode Screen
[(https://screen.encodeproject.org/#)]


```{r  enhancers of the heart}
# BiocManager::install("plyranges")
# enhancers_HLV_46F <- genomation::readBed("C:/Users/renee/Downloads/Supplements folde manuscriptr/ENCODE/heart_left_ventricle_tissue_female_adult_46_years.enhancers.bed")
cREs_HLV_46F <- genomation::readBed("data/enhancerdata/ENCFF867HAD_ENCFF152PBB_ENCFF352YYH_ENCFF252IVK.7group.bed")

# cREs_HLV_53F <- genomation::readBed("data/enhancerdata/ENCFF417JSF_ENCFF651XRK_ENCFF320IPT_ENCFF440RUS.7group.bed") 
 
NR_cREs <- join_overlap_intersect(NR_gr,cREs_HLV_46F)
LR_open_cREs <- join_overlap_intersect(LR_open_gr,cREs_HLV_46F)
LR_close_cREs <- join_overlap_intersect(LR_close_gr,cREs_HLV_46F)
ESR_open_cREs <- join_overlap_intersect(ESR_open_gr,cREs_HLV_46F)
ESR_close_cREs <- join_overlap_intersect(ESR_close_gr,cREs_HLV_46F)
ESR_OC_cREs <- join_overlap_intersect(ESR_OC_gr,cREs_HLV_46F)
EAR_open_cREs <- join_overlap_intersect(EAR_open_gr,cREs_HLV_46F)
EAR_close_cREs <- join_overlap_intersect(EAR_close_gr,cREs_HLV_46F)
### These unique peaks are cREs that contain all types of cREs such as
# [1] "Low-DNase"                "DNase-only"               "CTCF-only,CTCF-bound"    
#  [4] "PLS,CTCF-bound"           "PLS"                      "dELS"                    
#  [7] "pELS"                     "DNase-H3K4me3"            "DNase-H3K4me3,CTCF-bound"
# [10] "dELS,CTCF-bound"          "pELS,CTCF-bound" #### NOT the exact ones I am interested in.      
 uni_EAR_open  <-  EAR_open_cREs %>% as.data.frame() %>% distinct(Peakid)
 uni_EAR_close <- EAR_close_cREs %>% as.data.frame() %>% distinct(Peakid)
 uni_ESR_open <- ESR_open_cREs%>% as.data.frame() %>% distinct(Peakid)
 uni_ESR_close <- ESR_close_cREs%>% as.data.frame() %>% distinct(Peakid)
 uni_ESR_OC <- ESR_OC_cREs%>% as.data.frame() %>% distinct(Peakid)
 uni_LR_open <- LR_open_cREs%>% as.data.frame() %>% distinct(Peakid)
 uni_LR_close <- LR_close_cREs%>% as.data.frame() %>% distinct(Peakid)
 uni_NR <- NR_cREs%>% as.data.frame() %>% distinct(Peakid)


allpeak_gr <- peak_list_all_mrc %>% 
  GRanges(.)
Whole_peaks <- join_overlap_intersect(allpeak_gr, cREs_HLV_46F)


Whole_peaks %>% 
  as.data.frame() %>% 
  group_by(blockCount, mrc) %>%  tally %>% 
  pivot_wider(., id_cols = mrc, names_from = blockCount, values_from = n) %>% 
  dplyr::select(mrc, PLS:'pELS,CTCF-bound') %>% 
  kable(., caption="Breakdown of peaks overlapping cREs") %>% 
  kable_paper("striped", full_width = TRUE) %>%
  kable_styling(full_width = FALSE, font_size = 14)

```

### Visualization of categories:

First, filtering cRE set by type to include 'CTCF-only,CTCF-bound', 'PLS', 'PLS,CTCF-bound','dELS', 'dELS,CTCF-bound', 'pELS', 'pELS,CTCF-bound'.

Second, reclassify (new column) to group the CTCF-bound into their respective groups so only 4 groups, ("CTCF-only","PLS","dELS", "pELS") are created.

Third, left-join the median LFC for both 3 hour and 24 hour data to data set and boxplot by group.

Fourth, rbind two more data frames to help with ggplot visualization

PLS= promoter like sequences
pELS= proximal enhancer like sequences
dELS=distal enhancer like sequences

#### EAR open
```{r EAR cRE open3 and 24 hours, dev=c("png","pdf")}
all_EAR_open_list <- 
  peak_list_all_mrc %>% 
  dplyr::filter(mrc=="EAR_open") %>% 
  mutate(type="all_EAR_open") %>% 
   dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
    pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 
  
notCRE_EAR_open_list <- peak_list_all_mrc %>% 
  dplyr::filter(mrc=="EAR_open") %>% 
  dplyr::filter(!Peakid %in% uni_EAR_open$Peakid) %>% 
  mutate(type="not_cRE_peaks") %>% 
  dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 

EAR_open_cRE_list <- EAR_open_cREs %>%
  as.data.frame() %>%
  dplyr::filter(blockCount=="CTCF-only,CTCF-bound"|
                  blockCount =="PLS"|
                  blockCount =="PLS,CTCF-bound"|
                  blockCount =="dELS"|
                  blockCount =="dELS,CTCF-bound"|
                  blockCount =="pELS"|
                  blockCount =="pELS,CTCF-bound") %>% 
  mutate(type=if_else(blockCount=="CTCF-only,CTCF-bound","CTCF-only", if_else(grepl("PLS",blockCount),"Promoter-like",                       if_else(grepl("pELS",blockCount),"Proximal enhancer-like", "Distal enhancer-like"),blockCount))) %>%
  dplyr::select(Peakid,type) %>% 
    mutate(mrc="EAR_open") %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 


EAR_open_cRE_list %>% 
  rbind(notCRE_EAR_open_list) %>% 
  rbind(all_EAR_open_list) %>% 
  ggplot(., aes(y=type, x=lfc,group=type))+
  geom_boxplot() +
  scale_fill_discrete()+
  ggtitle(paste(" 24 hour EAR_open\n n = ",length(unique(EAR_open_cRE_list$Peakid))," out of ",peakAnnoList_ff_8motif$EAR_open@peakNum, " total peaks (",sprintf("%.1f",(length(unique(EAR_open_cRE_list$Peakid))/peakAnnoList_ff_8motif$EAR_open@peakNum*100)),"%)"))#+
  # facet_wrap(~direction)+
  theme_bw()#+
  # xlim(-4,4)

EAR_open_complete_list <- EAR_open_cRE_list %>% 
  rbind(notCRE_EAR_open_list) %>% 
  rbind(all_EAR_open_list)
```

#### EAR close

```{r  EAR cRE close3 and 24 hours}
all_EAR_close_list <- 
  peak_list_all_mrc %>% 
  dplyr::filter(mrc=="EAR_close") %>% 
  mutate(type="all_EAR_close") %>% 
   dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
    pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 
  
notCRE_EAR_close_list <- peak_list_all_mrc %>% 
  dplyr::filter(mrc=="EAR_close") %>% 
  dplyr::filter(!Peakid %in% uni_EAR_close$Peakid) %>% 
  mutate(type="not_cRE_peaks") %>% 
  dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 

EAR_close_cRE_list <- EAR_close_cREs %>%
  as.data.frame() %>%
  dplyr::filter(blockCount=="CTCF-only,CTCF-bound"|
                  blockCount =="PLS"|
                  blockCount =="PLS,CTCF-bound"|
                  blockCount =="dELS"|
                  blockCount =="dELS,CTCF-bound"|
                  blockCount =="pELS"|
                  blockCount =="pELS,CTCF-bound") %>% 
  mutate(type=if_else(blockCount=="CTCF-only,CTCF-bound","CTCF-only", if_else(grepl("PLS",blockCount),"Promoter-like",                       if_else(grepl("pELS",blockCount),"Proximal enhancer-like", "Distal enhancer-like"),blockCount))) %>%
  dplyr::select(Peakid,type) %>% 
    mutate(mrc="EAR_close") %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 


EAR_close_cRE_list %>% 
  rbind(notCRE_EAR_close_list) %>% 
  rbind(all_EAR_close_list) %>% 
  ggplot(., aes(y=type, x=lfc,group=type))+
  geom_boxplot() +
  scale_fill_discrete()+
  ggtitle(paste0(" 24 hour EAR_close\n n = ",length(unique(EAR_close_cRE_list$Peakid))," out of ", peakAnnoList_ff_8motif$EAR_close@peakNum, " total peaks (",sprintf("%.1f",length(unique(EAR_close_cRE_list$Peakid))/ peakAnnoList_ff_8motif$EAR_close@peakNum*100),"%)"))#+
  # facet_wrap(~direction)+
  # theme_bw()+
  # xlim(-4,4)

EAR_close_complete_list <- EAR_close_cRE_list %>% 
  rbind(notCRE_EAR_close_list) %>% 
  rbind(all_EAR_close_list)
```

#### ESR close

```{r  ESR cRE close3 and 24 hours}
all_ESR_close_list <- 
  peak_list_all_mrc %>% 
  dplyr::filter(mrc=="ESR_close") %>% 
  mutate(type="all_ESR_close") %>% 
   dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
    pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 
  
notCRE_ESR_close_list <- peak_list_all_mrc %>% 
  dplyr::filter(mrc=="ESR_close") %>% 
  dplyr::filter(!Peakid %in% uni_ESR_close$Peakid) %>% 
  mutate(type="not_cRE_peaks") %>% 
  dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 

ESR_close_cRE_list <- ESR_close_cREs %>%
  as.data.frame() %>%
  dplyr::filter(blockCount=="CTCF-only,CTCF-bound"|
                  blockCount =="PLS"|
                  blockCount =="PLS,CTCF-bound"|
                  blockCount =="dELS"|
                  blockCount =="dELS,CTCF-bound"|
                  blockCount =="pELS"|
                  blockCount =="pELS,CTCF-bound") %>% 
  mutate(type=if_else(blockCount=="CTCF-only,CTCF-bound","CTCF-only", if_else(grepl("PLS",blockCount),"Promoter-like",                       if_else(grepl("pELS",blockCount),"Proximal enhancer-like", "Distal enhancer-like"),blockCount))) %>%
  dplyr::select(Peakid,type) %>% 
    mutate(mrc="ESR_close") %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 


ESR_close_cRE_list %>% 
  rbind(notCRE_ESR_close_list) %>% 
  rbind(all_ESR_close_list) %>% 
  ggplot(., aes(y=type, x=lfc,group=type))+
  geom_boxplot() +
  scale_fill_discrete()+
  ggtitle(paste0(" 24 hour ESR_close\n n = ",length(unique(ESR_close_cRE_list$Peakid))," out of ",  peakAnnoList_ff_8motif$ESR_close@peakNum, " total peaks (",sprintf("%.1f",length(unique(ESR_close_cRE_list$Peakid))/ peakAnnoList_ff_8motif$ESR_close@peakNum*100),"%)"))#+
  # facet_wrap(~direction)+
  # theme_bw()+
  # xlim(-4,4)

ESR_close_complete_list <- ESR_close_cRE_list %>% 
  rbind(notCRE_ESR_close_list) %>% 
  rbind(all_ESR_close_list)

```

#### ESR open

```{r  ESR cRE open 3 and 24 hours}
all_ESR_open_list <- 
  peak_list_all_mrc %>% 
  dplyr::filter(mrc=="ESR_open") %>% 
  mutate(type="all_ESR_open") %>% 
   dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
    pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 
  
notCRE_ESR_open_list <- peak_list_all_mrc %>% 
  dplyr::filter(mrc=="ESR_open") %>% 
  dplyr::filter(!Peakid %in% uni_ESR_open$Peakid) %>% 
  mutate(type="not_cRE_peaks") %>% 
  dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 

ESR_open_cRE_list <- ESR_open_cREs %>%
  as.data.frame() %>%
  dplyr::filter(blockCount=="CTCF-only,CTCF-bound"|
                  blockCount =="PLS"|
                  blockCount =="PLS,CTCF-bound"|
                  blockCount =="dELS"|
                  blockCount =="dELS,CTCF-bound"|
                  blockCount =="pELS"|
                  blockCount =="pELS,CTCF-bound") %>% 
  mutate(type=if_else(blockCount=="CTCF-only,CTCF-bound","CTCF-only", if_else(grepl("PLS",blockCount),"Promoter-like",                       if_else(grepl("pELS",blockCount),"Proximal enhancer-like", "Distal enhancer-like"),blockCount))) %>%
  dplyr::select(Peakid,type) %>% 
    mutate(mrc="ESR_open") %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 


ESR_open_cRE_list %>% 
  rbind(notCRE_ESR_open_list) %>% 
  rbind(all_ESR_open_list) %>% 
  ggplot(., aes(y=type, x=lfc,group=type))+
  geom_boxplot() +
  scale_fill_discrete()+
  ggtitle(paste0(" 24 hour ESR_open\n n = ",length(unique(ESR_open_cRE_list$Peakid))," out of ",  peakAnnoList_ff_8motif$ESR_open@peakNum, " total peaks (",sprintf("%.1f",length(unique(ESR_open_cRE_list$Peakid))/ peakAnnoList_ff_8motif$ESR_open@peakNum*100),"%)"))#+
  # facet_wrap(~direction)+
  # theme_bw()+
  # xlim(-4,4)

ESR_open_complete_list <- ESR_open_cRE_list %>% 
  rbind(notCRE_ESR_open_list) %>% 
  rbind(all_ESR_open_list)

```

#### ESR OC
```{r  ESR cRE OC 3 and 24 hours}
all_ESR_OC_list <- 
  peak_list_all_mrc %>% 
  dplyr::filter(mrc=="ESR_OC") %>% 
  mutate(type="all_ESR_OC") %>% 
   dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
    pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 
  
notCRE_ESR_OC_list <- peak_list_all_mrc %>% 
  dplyr::filter(mrc=="ESR_OC") %>% 
  dplyr::filter(!Peakid %in% uni_ESR_OC$Peakid) %>% 
  mutate(type="not_cRE_peaks") %>% 
  dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 

ESR_OC_cRE_list <- ESR_OC_cREs %>%
  as.data.frame() %>%
  dplyr::filter(blockCount=="CTCF-only,CTCF-bound"|
                  blockCount =="PLS"|
                  blockCount =="PLS,CTCF-bound"|
                  blockCount =="dELS"|
                  blockCount =="dELS,CTCF-bound"|
                  blockCount =="pELS"|
                  blockCount =="pELS,CTCF-bound") %>% 
  mutate(type=if_else(blockCount=="CTCF-only,CTCF-bound","CTCF-only", if_else(grepl("PLS",blockCount),"Promoter-like",                       if_else(grepl("pELS",blockCount),"Proximal enhancer-like", "Distal enhancer-like"),blockCount))) %>%
  dplyr::select(Peakid,type) %>% 
    mutate(mrc="ESR_OC") %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 


ESR_OC_cRE_list %>% 
  rbind(notCRE_ESR_OC_list) %>% 
  rbind(all_ESR_OC_list) %>% 
  ggplot(., aes(y=type, x=lfc,group=type))+
  geom_boxplot() +
  scale_fill_discrete()+
  ggtitle(paste0(" 24 hour ESR_OC\n n = ",length(unique(ESR_OC_cRE_list$Peakid))," out of ",  peakAnnoList_ff_8motif$ESR_OC@peakNum, " total peaks (",sprintf("%.1f",length(unique(ESR_OC_cRE_list$Peakid))/ peakAnnoList_ff_8motif$ESR_OC@peakNum*100),"%)"))#+
  # facet_wrap(~direction)+
  # theme_bw()+
  # xlim(-4,4)

ESR_OC_complete_list <- ESR_OC_cRE_list %>% 
  rbind(notCRE_ESR_OC_list) %>% 
  rbind(all_ESR_OC_list)

```

#### LR open
```{r  LR cRE open 3 and 24 hours}
all_LR_open_list <- 
  peak_list_all_mrc %>% 
  dplyr::filter(mrc=="LR_open") %>% 
  mutate(type="all_LR_open") %>% 
   dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
    pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 
  
notCRE_LR_open_list <- peak_list_all_mrc %>% 
  dplyr::filter(mrc=="LR_open") %>% 
  dplyr::filter(!Peakid %in% uni_LR_open$Peakid) %>% 
  mutate(type="not_cRE_peaks") %>% 
  dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 

LR_open_cRE_list <- LR_open_cREs %>%
  as.data.frame() %>%
  dplyr::filter(blockCount=="CTCF-only,CTCF-bound"|
                  blockCount =="PLS"|
                  blockCount =="PLS,CTCF-bound"|
                  blockCount =="dELS"|
                  blockCount =="dELS,CTCF-bound"|
                  blockCount =="pELS"|
                  blockCount =="pELS,CTCF-bound") %>% 
  mutate(type=if_else(blockCount=="CTCF-only,CTCF-bound","CTCF-only", if_else(grepl("PLS",blockCount),"Promoter-like",                       if_else(grepl("pELS",blockCount),"Proximal enhancer-like", "Distal enhancer-like"),blockCount))) %>%
  dplyr::select(Peakid,type) %>% 
    mutate(mrc="LR_open") %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 


LR_open_cRE_list %>% 
  rbind(notCRE_LR_open_list) %>% 
  rbind(all_LR_open_list) %>% 
  ggplot(., aes(y=type, x=lfc,group=type))+
  geom_boxplot() +
  scale_fill_discrete()+
 ggtitle(paste0(" 24 hour LR_open\n n = ",length(unique(LR_open_cRE_list$Peakid))," out of ",  peakAnnoList_ff_8motif$LR_open@peakNum, " total peaks (",sprintf("%.1f",length(unique(LR_open_cRE_list$Peakid))/ peakAnnoList_ff_8motif$LR_open@peakNum*100),"%)"))#+
  # facet_wrap(~direction)+
  # theme_bw()+
  # xlim(-4,4)

LR_open_complete_list <- LR_open_cRE_list %>% 
  rbind(notCRE_LR_open_list) %>% 
  rbind(all_LR_open_list)
LR_open
```

#### LR close
```{r  LR cRE close 3 and 24 hours}

all_LR_close_list <- 
  peak_list_all_mrc %>% 
  dplyr::filter(mrc=="LR_close") %>% 
  mutate(type="all_LR_close") %>% 
   dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
    pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 
  
notCRE_LR_close_list <- peak_list_all_mrc %>% 
  dplyr::filter(mrc=="LR_close") %>% 
  dplyr::filter(!Peakid %in% uni_LR_close$Peakid) %>% 
  mutate(type="not_cRE_peaks") %>% 
  dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 

LR_close_cRE_list <- LR_close_cREs %>%
  as.data.frame() %>%
  dplyr::filter(blockCount=="CTCF-only,CTCF-bound"|
                  blockCount =="PLS"|
                  blockCount =="PLS,CTCF-bound"|
                  blockCount =="dELS"|
                  blockCount =="dELS,CTCF-bound"|
                  blockCount =="pELS"|
                  blockCount =="pELS,CTCF-bound") %>% 
  mutate(type=if_else(blockCount=="CTCF-only,CTCF-bound","CTCF-only", if_else(grepl("PLS",blockCount),"Promoter-like",                       if_else(grepl("pELS",blockCount),"Proximal enhancer-like", "Distal enhancer-like"),blockCount))) %>%
  dplyr::select(Peakid,type) %>% 
    mutate(mrc="LR_close") %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 


LR_close_cRE_list %>% 
  rbind(notCRE_LR_close_list) %>% 
  rbind(all_LR_close_list) %>% 
  ggplot(., aes(y=type, x=lfc,group=type))+
  geom_boxplot() +
  scale_fill_discrete()+
  ggtitle(paste0(" 24 hour LR_close\n n = ",length(unique(LR_close_cRE_list$Peakid))," out of ",  peakAnnoList_ff_8motif$LR_close@peakNum, " total peaks (",sprintf("%.1f",length(unique(LR_close_cRE_list$Peakid))/ peakAnnoList_ff_8motif$LR_close@peakNum*100),"%)"))#+
  # facet_wrap(~direction)+
  # theme_bw()+
  # xlim(-4,4)

LR_close_complete_list <- LR_close_cRE_list %>% 
  rbind(notCRE_LR_close_list) %>% 
  rbind(all_LR_close_list)

```

#### No response
```{r  NRcRE 3 and 24 hours}

all_NR_list <- 
  peak_list_all_mrc %>% 
  dplyr::filter(mrc=="NR") %>% 
  mutate(type="all_NR") %>% 
   dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
    pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 
  
notCRE_NR_list <- peak_list_all_mrc %>% 
  dplyr::filter(mrc=="NR") %>% 
  dplyr::filter(!Peakid %in% uni_NR$Peakid) %>% 
  mutate(type="not_cRE_peaks") %>% 
  dplyr::select(Peakid,mrc,type) %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 

NR_cRE_list <- NR_cREs %>%
  as.data.frame() %>%
  dplyr::filter(blockCount=="CTCF-only,CTCF-bound"|
                  blockCount =="PLS"|
                  blockCount =="PLS,CTCF-bound"|
                  blockCount =="dELS"|
                  blockCount =="dELS,CTCF-bound"|
                  blockCount =="pELS"|
                  blockCount =="pELS,CTCF-bound") %>% 
  mutate(type=if_else(blockCount=="CTCF-only,CTCF-bound","CTCF-only", if_else(grepl("PLS",blockCount),"Promoter-like",                       if_else(grepl("pELS",blockCount),"Proximal enhancer-like", "Distal enhancer-like"),blockCount))) %>%
  dplyr::select(Peakid,type) %>% 
    mutate(mrc="NR") %>% 
  left_join(.,(median_24_lfc %>% ungroup%>% 
                 dplyr::select(peak,med_24h_lfc)),by = c("Peakid"="peak")) %>% 
  left_join(.,(median_3_lfc %>%ungroup %>% 
                 dplyr::select(peak,med_3h_lfc)),by = c("Peakid"="peak")) %>% 
  pivot_longer(cols = c("med_24h_lfc","med_3h_lfc"), names_to = "time", values_to = "lfc") 


NR_cRE_list %>% 
  rbind(notCRE_NR_list) %>% 
  rbind(all_NR_list) %>% 
  ggplot(., aes(y=type, x=lfc,group=type))+
  geom_boxplot() +
  scale_fill_discrete()+
  ggtitle(paste0(" 24 hour NR\n n = ",length(unique(NR_cRE_list$Peakid))," out of ",  peakAnnoList_ff_8motif$NR@peakNum, " total peaks (",sprintf("%.1f",length(unique(NR_cRE_list$Peakid))/ peakAnnoList_ff_8motif$NR@peakNum*100),"%)"))#+
  # facet_wrap(~direction)+
  # theme_bw()+
  # xlim(-4,4)


NR_complete_list <- NR_cRE_list %>% 
  rbind(notCRE_NR_list) %>% 
  rbind(all_NR_list)

```

##### GO analysis of  neargenes from Peaks that are within 2kb of Neargene TSS.

```{r peak lists for go}
background_NGs <- col_ng_peak %>% 
  dplyr::select (Peakid,NCBI_gene:dist_to_NG) %>% 
  # dplyr::filter (dist_to_NG >-2000&dist_to_NG <2000) %>% 
  distinct(SYMBOL)
EAR_openNG <- EAR_open_list_all %>%
  dplyr::select (Peakid,SYMBOL,dist_to_NG) %>% 
  dplyr::filter (dist_to_NG >-2000&dist_to_NG <2000) %>%
  distinct(SYMBOL)
EAR_closeNG <- EAR_close_list_all %>%
  dplyr::select (Peakid,SYMBOL,dist_to_NG) %>% 
  dplyr::filter (dist_to_NG >-2000&dist_to_NG <2000) %>%
  distinct(SYMBOL)
ESR_openNG <- ESR_open_list_all %>%
  dplyr::select (Peakid,SYMBOL,dist_to_NG) %>% 
  dplyr::filter (dist_to_NG >-2000&dist_to_NG <2000) %>%
  distinct(SYMBOL)
ESR_closeNG <- ESR_close_list_all %>%
  dplyr::select (Peakid,SYMBOL,dist_to_NG) %>% 
  dplyr::filter (dist_to_NG >-2000&dist_to_NG <2000) %>%
  distinct(SYMBOL)
ESR_OCNG <- ESR_OC_list_all %>%
  dplyr::select (Peakid,SYMBOL,dist_to_NG) %>% 
  dplyr::filter (dist_to_NG >-2000&dist_to_NG <2000) %>%
  distinct(SYMBOL)
LR_openNG <- LR_open_list_all %>%
  dplyr::select (Peakid,SYMBOL,dist_to_NG) %>% 
  dplyr::filter (dist_to_NG >-2000&dist_to_NG <2000) %>%
  distinct(SYMBOL)
LR_closeNG <- LR_close_list_all %>%
  dplyr::select (Peakid,SYMBOL,dist_to_NG) %>% 
  dplyr::filter (dist_to_NG >-2000&dist_to_NG <2000) %>%
  distinct(SYMBOL)
NR_NG <- NR_list_all %>%
  dplyr::select (Peakid,SYMBOL,dist_to_NG) %>% 
  dplyr::filter (dist_to_NG >-2000&dist_to_NG <2000) %>%
  distinct(SYMBOL)

```



```{r}
scale_fill_mrc <-  function(...){
  ggplot2:::manual_scale(
    'fill', 
    values = setNames(c("#F8766D","#f6483c","#7CAE00","#587b00","#6a9500",  "#00BFC4","#008d91", "#C77CFF"), c("EAR_open","EAR_close","ESR_open","ESR_close","ESR_OC","LR_open","LR_close","NR")), 
    ...
  )
}

```


### summarizing plots:

```{r comboplots, fig.width=12, fig.height=8}
ggplot_combo_df <-
  rbind(EAR_open_complete_list,
                         EAR_close_complete_list,
                         ESR_open_complete_list,
                          ESR_close_complete_list,
                          ESR_OC_complete_list,
                          LR_open_complete_list,
                          LR_close_complete_list,
                          NR_complete_list) 
ggplot_combo_df %>% 
  mutate(time=factor(time, levels= c("med_3h_lfc", "med_24h_lfc"), labels=c("3 hours","24 hours"))) %>%
     mutate(type= if_else(type=="Promoter-like",type,
                          if_else(type =="Proximal enhancer-like",type,if_else(type=="Distal enhancer-like", type,if_else(type=="CTCF-only",type,if_else(type=="not_cRE_peaks", type, "all")))))) %>%
  mutate(type=factor(type, levels = c("Promoter-like","Proximal enhancer-like","Distal enhancer-like","CTCF-only","not_cRE_peaks","all"))) %>% 
  
  ggplot(., aes(y=type, x=lfc, fill=mrc))+
    geom_boxplot()+
  # geom_pointrange(aes(xmin=min_val, xmax=max_val),position=position_dodge(width =.7),  width=.3,size=0.5,shape=15, fatten=8)+
  geom_vline(xintercept = 0, linetype=2)+
  facet_wrap(~time) + 
  theme_classic()+
  scale_fill_mrc()

```













### Top2b
to be determined.... ingnore for now
```{r Top2b peaks, eval=FALSE, include=FALSE}

### created the marked dataframe with mRC
Peak_MRC_table <- TSS_NG_data %>%
    distinct(Peakid, .keep_all = TRUE) %>% 
    mutate(mrc=if_else(Peakid %in% EAR_df$id, "EAR",
                     if_else(Peakid %in% ESR_df$id,"ESR",
                             if_else(Peakid %in% LR_df$id,"LR",
                                     if_else(peakid %in% NR_df$id,"NR","not_mrc")))))%>%
    dplyr::select(peakid:end,entrezgene_id:mrc) 
  
##overlapping and intersection top2b peaks with my peaks
top2Boverlap <- join_overlap_intersect(all_peak_gr,Top2b_peaks_gr)

### TAking the list of peaks dataframe by MRC and joining with marked group above so neargenes by TSS are joined thenchecking for distance to neargene across categories

peak_list_all_MRC %>% 
  dplyr::filter(peakid %in% top2Boverlap$id) %>% 
  dplyr::select(peakid,MRC) %>% 
  left_join(.,Peak_MRC_table, by=c("peakid"="peakid")) %>% 
  ggplot(., aes(x=mrc,y=dist_to_NG))+
  geom_boxplot()
peak_list_all_MRC %>% 
  dplyr::filter(peakid %in% top2Boverlap$id) %>% 
  dplyr::select(peakid,MRC) %>% 
  left_join(.,median_24_lfc, by=c("peakid"="peak")) %>% 
  ggplot(., aes(x=MRC,y=median))+
  geom_boxplot()  +
  theme_bw()+
  ggtitle("24 hr median logFC across response peaks overlapped with TOP2B")+
  coord_cartesian(ylim= c(-3.5,2))

peak_list_all_MRC %>% 
  dplyr::filter(peakid %in% top2Boverlap$id) %>% 
  dplyr::select(peakid,MRC) %>% 
  left_join(.,median_3_lfc, by=c("peakid"="peak")) %>% 
  ggplot(., aes(x=MRC,y=median))+
  geom_boxplot()  +
   theme_bw()+
  ggtitle("3 hr median logFC across response peaks overlapped with TOP2B")+
  coord_cartesian(ylim= c(-3.5,2))

```

### Counts of peaks-

```{r top2b_cluster, eval=FALSE, include=FALSE}
peak_list_all_MRC %>% 
  dplyr::filter(peakid %in% top2Boverlap$id) %>% 
  dplyr::select(peakid,MRC) %>% 
  left_join(.,Peak_MRC_table, by=c("peakid"="peakid")) %>% 
  group_by(MRC) %>% 
  tally


```

```{r peaks not in CREs}

```

